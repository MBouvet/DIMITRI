<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Thu Jul  4 16:01:52 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>get_parasol_l1b_data.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="get_parasol_l1b_data.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;*</span>
<span class="comments">;* NAME:</span>
<span class="comments">;*      GET_PARASOL_L1B_DATA       </span>
<span class="comments">;* </span>
<span class="comments">;* PURPOSE:</span>
<span class="comments">;*      RETURNS THE IMAGE DATA FOR A SPECIFIC PARASOL PRODUCT</span>
<span class="comments">;* </span>
<span class="comments">;* CALLING SEQUENCE:</span>
<span class="comments">;*      RES = GET_PARASOL_L1B_DATA(FILENAME)      </span>
<span class="comments">;* </span>
<span class="comments">;* INPUTS:</span>
<span class="comments">;*      FILENAME - A SCALAR CONTAINING THE FILENAME OF THE PRODUCT FOR RADIANCE EXTRACTION </span>
<span class="comments">;*</span>
<span class="comments">;* KEYWORDS:</span>
<span class="comments">;*      ENDIAN_SIZE - MACHINE ENDIAN SIZE (0: LITTLE, 1: BIG)</span>
<span class="comments">;*      VERBOSE     - PROCESSING STATUS OUTPUTS</span>
<span class="comments">;*</span>
<span class="comments">;* OUTPUTS:</span>
<span class="comments">;*      L1B_DATA     - A STRUCTURE OF THE IMAGE DATA INCLUDING REFLECTANCES VIEWING GEOMETRIES ETC </span>
<span class="comments">;*</span>
<span class="comments">;* COMMON BLOCKS:</span>
<span class="comments">;*      NONE</span>
<span class="comments">;*</span>
<span class="comments">;* MODIFICATION HISTORY:</span>
<span class="comments">;*             2005 - M BOUVET - PROTOTYPE DIMITRI VERSION</span>
<span class="comments">;*      15 DEC 2010 - C KENT   - DIMITRI-2 V1.0</span>
<span class="comments">;*      29 FEB 2012 - C KENT   - ADDED SEQUENCE NUMBER EXTRACTION</span>
<span class="comments">;*      08 MAR 2012 - C KENT   - UPDATED SATURATION/DUMMY VALUES CHECK</span>
<span class="comments">;*</span>
<span class="comments">;* VALIDATION HISTORY:</span>
<span class="comments">;*      10 JAN 2011 - C KENT   - WINDOWS 32 BIT MACHINE, IDL 7.1: RESULTS EQUAL TO ANAPOL, </span>
<span class="comments">;*                               EXCEPT SAA (ANAPOL USED SLOPE=1.42, WE USE 1.4 AS DETAILED </span>
<span class="comments">;*                               IN THE L1 PRODUCT FORMAT DOCUMENT)</span>
<span class="comments">;*                             - LINUX 64-BIT MACHINE, IDL 8.0: COMPILATION SUCESSFUL, </span>
<span class="comments">;*                               RESULTS EQUAL TO WINDOWS MACHINE </span>
<span class="comments">;*</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

FUNCTION GET_PARASOL_L1B_DATA,FILENAME,ENDIAN_SIZE=ENDIAN_SIZE,VERBOSE=VERBOSE

<span class="comments">;------------------------</span>
<span class="comments">; KEYWORD PARAMETER CHECK</span>

  IF STRCMP(FILENAME,'') THEN BEGIN
    PRINT, 'PARASOL L1B DATA: NO INPUT FILES PROVIDED, RETURNING...'
    RETURN,-1
  ENDIF  
  
<span class="comments">;-----------------------------------------------</span>
<span class="comments">; CHECK FILENAME OS A PARASOL DATA FILE</span>

  TEMP = STRMATCH(FILENAME,'*P3L1TBG*D*')
  IF TEMP EQ 0 THEN BEGIN
    PRINT, 'PARASOL L1B DATA: ERROR, INPUT FILE NOT A PARASOL DATA FILE'
    RETURN,-1
  ENDIF

<span class="comments">;------------------------------------------------</span>
<span class="comments">; CHECK THAT THE FILE EXISTS</span>

  TEMP = FILE_INFO(FILENAME)
  IF TEMP.EXISTS EQ 0 THEN BEGIN
    PRINT, 'PARASOL L1B DATA: ERROR, INPUT FILE DOES NOT EXIST'
    RETURN,-1
  ENDIF

<span class="comments">;------------------------------------------------</span>
<span class="comments">; IF ENDIAN SIZE NOT PROVIDED THEN GET VALUE</span>

   IF N_ELEMENTS(ENDIAN_SIZE) EQ 0 THEN BEGIN
    IF KEYWORD_SET(VERBOSE) THEN BEGIN
      PRINT, 'PARASOL L1B DATA: NO ENDIAN SIZE PROVIDED, RETRIEVING...'
      ENDIAN_SIZE = GET_ENDIAN_SIZE(/VERBOSE)
    ENDIF ELSE ENDIAN_SIZE = GET_ENDIAN_SIZE()
  ENDIF

<span class="comments">;------------------------------------------------</span>
<span class="comments">; OPEN THE PRODUCT AND READ NUMBER AND SIZE OF RECORDS</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'PARASOL L1B DATA: OPENING AND READING THE PRODUCT LOG'
  OPENR,IN_PARA,FILENAME,/GET_LUN
  TEMP = BYTARR(52)
  NUM_RECS = ULONG(1)
  REC_SIZE = ULONG(1)
  READU,IN_PARA,TEMP
  READU,IN_PARA,NUM_RECS
  READU,IN_PARA,REC_SIZE 

<span class="comments">;------------------------------------------------</span>
<span class="comments">; SWAP ENDIAN IF NEEDED - DATA IS BIG ENDIAN</span>

  IF ENDIAN_SIZE EQ 0 THEN BEGIN
    NUM_RECS = SWAP_ENDIAN(NUM_RECS)
    REC_SIZE = SWAP_ENDIAN(REC_SIZE)
  ENDIF

<span class="comments">;------------------------------------------------</span>
<span class="comments">; GET THE PIXEL STRUCTURE</span>
  
  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'PARASOL L1B DATA: RETRIEVING PIXEL STRUCTURE'
  L1B_PIXELS = GET_PARASOL_L1B_PIXEL_STRUCTURE(NUM_RECS)
  L1B_PIXEL  = GET_PARASOL_L1B_PIXEL_STRUCTURE(1)

<span class="comments">;------------------------------------------------</span>
<span class="comments">; DEFINE TEMPORARY VARIABLES FOR READING</span>

  TEMP_HDR = 180
  TEMP_SSI = INTARR(1)
  TEMP_USI = UINTARR(1)
  TEMP_ULI = ULONARR(1)
  TEMP_BYT = BYTARR(1)
  TEMP_REF = INTARR(15)

<span class="comments">;------------------------------------------------</span>
<span class="comments">; LOOP OVER EACH RECORD AND RETRIEVE DATA</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'PARASOL L1B DATA: STARTING READING LOOP'
  FOR IN_REC=0L,NUM_RECS-1 DO BEGIN
  
<span class="comments">;------------------------------------------------</span>
<span class="comments">; RETRIEVE LINE AND COLUMN INDEX</span>
    
    POINT_LUN,IN_PARA,TEMP_HDR+REC_SIZE*IN_REC+6
    READU,IN_PARA,TEMP_USI
      IF ENDIAN_SIZE EQ 0 THEN TEMP_USI = SWAP_ENDIAN(TEMP_USI)
    L1B_PIXELS[IN_REC].LINE=TEMP_USI
    READU,IN_PARA,TEMP_USI
      IF ENDIAN_SIZE EQ 0 THEN TEMP_USI = SWAP_ENDIAN(TEMP_USI)
    L1B_PIXELS[IN_REC].COLUMN=TEMP_USI

<span class="comments">;-----------------------------------------------</span>
<span class="comments">; COMPUTE GEOLOCATION FROM LINE AND COLUMN INDEX</span>

    IF KEYWORD_SET(VERBOSE) THEN PRINT, 'PARASOL L1B DATA: COMPUTING PIXEL GEOLOCATION'
    L1B_PIXELS[IN_REC].LATITUDE=90.0-(L1B_PIXELS[IN_REC].LINE-0.5)/18.0
    N_i=round(3240.0*cos(L1B_PIXELS[IN_REC].LATITUDE*!DTOR))*1.0
    L1B_PIXELS[IN_REC].LONGITUDE=180./N_i*(L1B_PIXELS[IN_REC].COLUMN-3240.5)

<span class="comments">;-----------------------------------------------</span>
<span class="comments">; RETRIEVE SAA AND NUMBER OF VIEWING DIRECTIONS</span>

    IF KEYWORD_SET(VERBOSE) THEN PRINT, 'PARASOL L1B DATA: RETRIEVING SAA AND NUMBER OF DIRECTIONS'
    POINT_LUN,IN_PARA,TEMP_HDR+REC_SIZE*IN_REC+46
    READU,IN_PARA,TEMP_BYT
      IF ENDIAN_SIZE EQ 0 THEN TEMP_BYT = SWAP_ENDIAN(TEMP_BYT)    
    L1B_PIXELS[IN_REC].SAA = TEMP_BYT*1.42
    READU,IN_PARA,TEMP_BYT
      IF ENDIAN_SIZE EQ 0 THEN TEMP_BYT = SWAP_ENDIAN(TEMP_BYT)    
    L1B_PIXELS[IN_REC].NUM_DIR = TEMP_BYT

<span class="comments">;----------------------------------------------</span>
<span class="comments">; IF NO DIRECTIONS AVAILABLE THEN SKIP PIXEL</span>

    IF L1B_PIXELS[IN_REC].NUM_DIR LT 1 THEN GOTO,NO_DIR

<span class="comments">;----------------------------------------------</span>
<span class="comments">; LOOP OVER THE DIRECTIONS</span>

    IF KEYWORD_SET(VERBOSE) THEN PRINT, 'PARASOL L1B DATA: LOOPING OVER DIRECTIONS'
    <span class="comments">;FOR IN_DIR = 0,L1B_PIXELS[IN_REC].NUM_DIR-1 DO BEGIN</span>
    FOR IN_DIR = 0,15 DO BEGIN

<span class="comments">;-----------------------------------------------</span>
<span class="comments">; RETRIEVE SEQUENCE NUMBER</span>

      POINT_LUN,IN_PARA,TEMP_HDR+REC_SIZE*IN_REC+43*IN_DIR+50
      READU,IN_PARA,TEMP_BYT
        IF ENDIAN_SIZE EQ 0 THEN TEMP_BYT = SWAP_ENDIAN(TEMP_BYT)    
      L1B_PIXELS[IN_REC].SEQ_NUMBER[IN_DIR] = TEMP_BYT

      POINT_LUN,IN_PARA,TEMP_HDR+REC_SIZE*IN_REC+43*IN_DIR+55 
      READU,IN_PARA,TEMP_USI
       IF ENDIAN_SIZE EQ 0 THEN TEMP_USI = SWAP_ENDIAN(TEMP_USI)     
      L1B_PIXELS[IN_REC].SZA[IN_DIR] = TEMP_USI*1.5e-3
 
      READU,IN_PARA,TEMP_USI
       IF ENDIAN_SIZE EQ 0 THEN TEMP_USI = SWAP_ENDIAN(TEMP_USI)     
      L1B_PIXELS[IN_REC].VZA[IN_DIR] = TEMP_USI*1.5e-3
 
      READU,IN_PARA,TEMP_USI
       IF ENDIAN_SIZE EQ 0 THEN TEMP_USI = SWAP_ENDIAN(TEMP_USI)     
      L1B_PIXELS[IN_REC].RAA[IN_DIR] = TEMP_USI*6.0e-3
  
      READU,IN_PARA,TEMP_BYT
      IF TEMP_BYT GT 127 THEN BEGIN
      L1B_PIXELS[IN_REC].DELTA_AV_COS_A[IN_DIR]=(TEMP_BYT-256)*1.6E-3
      ENDIF ELSE L1B_PIXELS[IN_REC].DELTA_AV_COS_A[IN_DIR]=TEMP_BYT*1.6E-3

      READU,IN_PARA,TEMP_BYT
      IF TEMP_BYT GT 127 THEN BEGIN
      L1B_PIXELS[IN_REC].DELTA_AV_SIN_A[IN_DIR]=(TEMP_BYT-256)*1.6E-3
      ENDIF ELSE L1B_PIXELS[IN_REC].DELTA_AV_SIN_A[IN_DIR]=TEMP_BYT*1.6E-3

<span class="comments">;---------------------------------------------           </span>
<span class="comments">; READ THE REFLECTANCES</span>

      TEMP_REF = INTARR(15)
      READU,IN_PARA,TEMP_REF 
      IF ENDIAN_SIZE EQ 0 THEN TEMP_REF=SWAP_ENDIAN(TEMP_REF)
      REF_SF = 1E-4
      
      TT = WHERE(TEMP_REF GE 32767 OR TEMP_REF LE -32767,COUNT)
      IF COUNT GT 0 THEN TEMP_REF[TT] = 0
      
      TEMP_REF = TEMP_REF*REF_SF
      
      L1B_PIXELS[IN_REC].REF_443NP[IN_DIR]  = TEMP_REF[0]<span class="comments">;*REF_SF);>0.0</span>
      L1B_PIXELS[IN_REC].REF_490P[IN_DIR]   = TEMP_REF[1]<span class="comments">;*REF_SF);>0.0</span>
      L1B_PIXELS[IN_REC].REF_1020NP[IN_DIR] = TEMP_REF[2]<span class="comments">;*REF_SF);>0.0</span>
      L1B_PIXELS[IN_REC].REF_565NP[IN_DIR]  = TEMP_REF[3]<span class="comments">;*REF_SF);>0.0</span>
      L1B_PIXELS[IN_REC].REF_670P[IN_DIR]   = TEMP_REF[4]<span class="comments">;*REF_SF);>0.0</span>
      L1B_PIXELS[IN_REC].REF_763NP[IN_DIR]  = TEMP_REF[5]<span class="comments">;*REF_SF);>0.0</span>
      L1B_PIXELS[IN_REC].REF_765NP[IN_DIR]  = TEMP_REF[6]<span class="comments">;*REF_SF);>0.0</span>
      L1B_PIXELS[IN_REC].REF_865P[IN_DIR]   = TEMP_REF[7]<span class="comments">;*REF_SF);>0.0</span>
      L1B_PIXELS[IN_REC].REF_910NP[IN_DIR]  = TEMP_REF[8]<span class="comments">;*REF_SF);>0.0</span>
      L1B_PIXELS[IN_REC].REF_490P_Q[IN_DIR] = TEMP_REF[9]<span class="comments">;*REF_SF);>0.0</span>
      L1B_PIXELS[IN_REC].REF_670P_Q[IN_DIR] = TEMP_REF[10]<span class="comments">;*REF_SF);>0.0</span>
      L1B_PIXELS[IN_REC].REF_865P_Q[IN_DIR] = TEMP_REF[11]<span class="comments">;*REF_SF);>0.0</span>
      L1B_PIXELS[IN_REC].REF_490P_U[IN_DIR] = TEMP_REF[12]<span class="comments">;*REF_SF);>0.0</span>
      L1B_PIXELS[IN_REC].REF_670P_U[IN_DIR] = TEMP_REF[13]<span class="comments">;*REF_SF);>0.0</span>
      L1B_PIXELS[IN_REC].REF_865P_U[IN_DIR] = TEMP_REF[14]<span class="comments">;*REF_SF);>0.0   </span>
   
    ENDFOR <span class="comments">;END OF DIRECTION LOOP</span>
   NO_DIR:
   ENDFOR<span class="comments">;END OF PIXEL LOOP</span>

<span class="comments">;------------------------------------</span>
<span class="comments">; CLOSE THE PRODUCT</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'PARASOL L1B DATA: CLOSING PRODUCT'
  FREE_LUN,IN_PARA

<span class="comments">;-------------------------------------</span>
<span class="comments">; CURRENT DIMITRI METHOD FOR GENERATING THE IMAGE</span>

  MIN_LON_PIX=MIN(L1B_PIXELS.COLUMN)
  MAX_LON_PIX=MAX(L1B_PIXELS.COLUMN)
  MIN_LAT_PIX=MIN(L1B_PIXELS.LINE)
  MAX_LAT_PIX=MAX(L1B_PIXELS.LINE)
  DIM_X_IMAGE=MAX_LON_PIX-MIN_LON_PIX+1
  DIM_Y_IMAGE=MAX_LAT_PIX-MIN_LAT_PIX+1

<span class="comments">;-------------------------------------</span>
<span class="comments">;GENERATE L1B_IMAGE TO BE POPULATED</span>
  
  L1B_IMAGE=REPLICATE(L1B_PIXEL[0], DIM_X_IMAGE, DIM_Y_IMAGE)

  COL_ID = L1B_PIXELS.COLUMN-MIN_LON_PIX
  ROW_ID = L1B_PIXELS.LINE-MIN_LAT_PIX
  L1B_IMAGE[COL_ID,ROW_ID]=L1B_PIXELS

<span class="comments">;  FOR I=0l,DIM_X_IMAGE-1 DO BEGIN</span>
<span class="comments">;    FOR J=0l,DIM_Y_IMAGE-1 DO BEGIN</span>
<span class="comments">;      RES = WHERE(L1B_PIXELS.COLUMN-MIN_LON_PIX EQ I AND L1B_PIXELS.LINE-MIN_LAT_PIX EQ J)</span>
<span class="comments">;      IF RES[0] GT -1 AND N_ELEMENTS(RES) EQ 1 THEN L1B_IMAGE[I,J]=L1B_PIXELS[RES]</span>
<span class="comments">;    ENDFOR</span>
<span class="comments">;  ENDFOR</span>

<span class="comments">;--------------------------------------</span>
<span class="comments">; RETURN DATA</span>

  RETURN,L1B_IMAGE

END
</code>
    </div>
  </body>
</html>