<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Tue Jul  2 12:50:56 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>get_meris_viewing_geometries.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="get_meris_viewing_geometries.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;*</span>
<span class="comments">;* NAME:</span>
<span class="comments">;*      GET_MERIS_VIEWING_GEOMETRIES       </span>
<span class="comments">;* </span>
<span class="comments">;* PURPOSE:</span>
<span class="comments">;*      RETURNS THE VIEWING GEOMETRIES OF A MERIS IMAGE</span>
<span class="comments">;* </span>
<span class="comments">;* CALLING SEQUENCE:</span>
<span class="comments">;*      RES = GET_MERIS_VIEWING_GEOMETRIES(FILENAME)      </span>
<span class="comments">;* </span>
<span class="comments">;* INPUTS:</span>
<span class="comments">;*      FILENAME - A SCALAR CONTAINING THE FILENAME OF THE PRODUCT FOR EXTRACTION      </span>
<span class="comments">;*</span>
<span class="comments">;* KEYWORDS:</span>
<span class="comments">;*     ENDIAN_SIZE  - MACHINE ENDIAN SIZE (0: LITTLE, 1: BIG)</span>
<span class="comments">;*     VERBOSE      - PROCESSING STATUS OUTPUTS</span>
<span class="comments">;*</span>
<span class="comments">;* OUTPUTS:</span>
<span class="comments">;*     STRUCT.SZA   - SOLAR ZENITH ANGLE IN DEGREES</span>
<span class="comments">;*     STRUCT.SAA   - SOLAR AZIMUTH ANGLE IN DEGREES</span>
<span class="comments">;*     STRUCT.VZA   - SENSOR ZENITH ANGLE IN DEGREES</span>
<span class="comments">;*     STRUCT.VAA   - SENSOR AZIMUTH ANGLE IN DEGREES</span>
<span class="comments">;*</span>
<span class="comments">;* COMMON BLOCKS:</span>
<span class="comments">;*     NONE </span>
<span class="comments">;*</span>
<span class="comments">;* MODIFICATION HISTORY:</span>
<span class="comments">;*     17 NOV 2005 - M BOUVET - PROTOTYPE DIMITRI VERSION</span>
<span class="comments">;*     18 NOV 2010 - C KENT   - DIMITRI-2 V1.0</span>
<span class="comments">;*     20 NOV 2010 - C KENT   - UPDATED TO ALLOW SINGULAR USAGE (REMOVED COMMON BLOCKS)</span>
<span class="comments">;*     22 NOV 2010 - C KENT   - ADDED VERBOSE KEYWORD OPTION</span>
<span class="comments">;*     01 DEC 2010 - C KENT   - ADDED FILENAME ERROR HANDLING</span>
<span class="comments">;*     02 DEC 2010 - C KENT   - UPDATED HEADER INFORMATION</span>
<span class="comments">;*     23 DEC 2010 - C KENT   - CHANGED CONVERSION TO DOUBLE ARRAYS DUE TO DIFFERENCES </span>
<span class="comments">;*                              BETWEEN WINDOWS/LINUX</span>
<span class="comments">;*</span>
<span class="comments">;* VALIDATION HISTORY:</span>
<span class="comments">;*     01 DEC 2010 - C KENT   - WINDOWS 32-BIT MACHINE: COMPILATION SUCCESSFUL,</span>
<span class="comments">;*                              VIEWING GEOMETRY RETIREVAL NOMINAL, VERY SLIGHT </span>
<span class="comments">;*                              DIFFERENCES (~0.0004 DEGREES) AGAINST BEAM VISAT.</span>
<span class="comments">;*     05 JAN 2010 - C KENT   - LINUX 64-BIT MACHINE IDL 8.0: COMPILATION SUCCESSFUL,</span>
<span class="comments">;*                              NO DIFFERENCES OBSERVED AGAINST WINDOWS 32-BIT MACHINE</span>
<span class="comments">;*</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

FUNCTION GET_MERIS_VIEWING_GEOMETRIES,FILENAME,ENDIAN_SIZE=ENDIAN_SIZE,VERBOSE=VERBOSE

<span class="comments">;------------------------------------------------</span>
<span class="comments">; CHECK FILENAME IS NOMINAL</span>

  IF FILENAME EQ '' THEN BEGIN
    PRINT, 'MERIS L1B VIEWING GEOMETRIES: ERROR, INPUT FILENAME INCORRECT'
    RETURN,-1
  ENDIF

<span class="comments">;------------------------------------------------</span>
<span class="comments">; IF ENDIAN SIZE NOT PROVIDED THEN GET VALUE</span>

  IF N_ELEMENTS(ENDIAN_SIZE) EQ 0 THEN BEGIN
    IF KEYWORD_SET(VERBOSE) THEN BEGIN
      PRINT, 'MERIS L1B VIEWING GEOMETRIES: NO ENDIAN SIZE PROVIDED, RETRIEVING...'
      ENDIAN_SIZE = GET_ENDIAN_SIZE(/VERBOSE)
    ENDIF ELSE ENDIAN_SIZE = GET_ENDIAN_SIZE()
  ENDIF

<span class="comments">;------------------------------------------------</span>
<span class="comments">;DEFINE HEADER VARIABLES</span>

  MPH_SIZE = 1247
  SPH_SIZE = 9942
  FILE_MPH = BYTARR(MPH_SIZE)
  FILE_SPH = BYTARR(SPH_SIZE)

<span class="comments">;-----------------------------------------------</span>
<span class="comments">; OPEN THE FILE AND EXTRACT HEADER</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B VIEWING GEOMETRIES: OPENING PRODUCT'
  OPENR,PRD_VIG,FILENAME,/GET_LUN
  READU,PRD_VIG,FILE_MPH
  READU,PRD_VIG,FILE_SPH

<span class="comments">;-----------------------------------------------</span>
<span class="comments">; RETRIEVE: POSITION OF DSD, TP SUBSAMPLING FREQUENCY,LINE SIZE,TP PER LINE,DSD,OFFSET,DS_SIZE,NUMBER OF RECORDS, RECORD SIZE</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B VIEWING GEOMETRIES: RETRIEVING DSD INFORMATION'
  TP_DSD_POS      = STRPOS(FILE_SPH,'DS_NAME="Tie points ADS              "')
  TP_SFREQ        = STRMID(FILE_SPH, STRPOS(FILE_SPH,'SAMPLES_PER_TIE_PT=+')+20, 3)+0L
  LINE_SIZE       = STRMID(FILE_SPH, STRPOS(FILE_SPH,'LINE_LENGTH=+')+13, 5)+0L
  NB_TP_LINE      = FLOOR(LINE_SIZE/TP_SFREQ)+1
  
  TP_DSD          = STRMID(FILE_SPH, TP_DSD_POS,280)
  TP_OFFSET       = STRMID(TP_DSD, STRPOS(TP_DSD, 'DS_OFFSET=+')+11,20)+0L
  TP_SIZE         = STRMID(TP_DSD, STRPOS(TP_DSD, 'DS_SIZE=+')  +9,20)+0L
  TP_DSR_NUMBER   = STRMID(TP_DSD, STRPOS(TP_DSD, 'NUM_DSR=+')  +9,20)+0L
  TP_DSR_SIZE     = STRMID(TP_DSD, STRPOS(TP_DSD, 'DSR_SIZE=+') +10,20)+0L

<span class="comments">;-----------------------------------------</span>
<span class="comments">; DEFINE ARRAY AND TEMPORARY TO HOLD DATA (SZA,SAA,VZA,VAA)</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B VIEWING GEOMETRIES: DEFINING DATA ARRAYS FOR OUTPUT'
  VIEW_GEO_SZA = LONARR(NB_TP_LINE,TP_DSR_NUMBER)
  VIEW_GEO_SAA = LONARR(NB_TP_LINE,TP_DSR_NUMBER)
  VIEW_GEO_VZA = LONARR(NB_TP_LINE,TP_DSR_NUMBER)
  VIEW_GEO_VAA = LONARR(NB_TP_LINE,TP_DSR_NUMBER)
  VIEW_REC = LONARR(NB_TP_LINE)
   
<span class="comments">;-----------------------------------------</span>
<span class="comments">; LOOP OVER EACH RECORD AND EXTRACT ALL VIEWING GEOMETRY DATA  </span>
  
  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B VIEWING GEOMETRIES: STARTING LOOP FOR DATA EXTRACTION'
  FOR VREC=0,TP_DSR_NUMBER-1 DO BEGIN
 
    POINT_LUN,PRD_VIG, TP_OFFSET+VREC*TP_DSR_SIZE+13+6*4*NB_TP_LINE
    READU,PRD_VIG,VIEW_REC
    VIEW_GEO_SZA[*,VREC] = VIEW_REC

    READU,PRD_VIG,VIEW_REC
    VIEW_GEO_SAA[*,VREC] = VIEW_REC

    READU,PRD_VIG,VIEW_REC
    VIEW_GEO_VZA[*,VREC] = VIEW_REC

    READU,PRD_VIG,VIEW_REC
    VIEW_GEO_VAA[*,VREC] = VIEW_REC
     
  ENDFOR <span class="comments">;END OF LOOP ON VIEWING GEOMETRY RECORDS</span>

<span class="comments">;----------------------------------------</span>
<span class="comments">; SWAP ENDIAN IF NEEDED - MERIS DATA IS BIG ENDIAN</span>
  
    IF ENDIAN_SIZE EQ 0 THEN BEGIN
      VIEW_GEO_SZA   = SWAP_ENDIAN(VIEW_GEO_SZA)
      VIEW_GEO_SAA   = SWAP_ENDIAN(VIEW_GEO_SAA)
      VIEW_GEO_VZA   = SWAP_ENDIAN(VIEW_GEO_VZA)
      VIEW_GEO_VAA   = SWAP_ENDIAN(VIEW_GEO_VAA)
    ENDIF
  
<span class="comments">;---------------------------------------</span>
<span class="comments">; CLOSE THE FILE</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B VIEWING GEOMETRIES: CLOSING PRODUCTS AND RELEASING THE LUN'
  CLOSE, PRD_VIG
  FREE_LUN, PRD_VIG
  
<span class="comments">;---------------------------------------</span>
<span class="comments">; FIND NUMBER OF PIXELS WITHIN MERIS RADIANCE FRAME</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B VIEWING GEOMETRIESN: RETRIEVE DIMENSIONS OF RADIANCE PRODUCT'
  RD_POS      = STRPOS(FILE_SPH,'DS_NAME="Radiance MDS(1)             "')
  RD_DSD      = STRMID(FILE_SPH, RD_POS,280)
  NB_RD_LINE  = STRMID(RD_DSD, STRPOS(RD_DSD, 'NUM_DSR=+')+9,20)  

<span class="comments">;---------------------------------------</span>
<span class="comments">; CONVERT VALUES INTO CORRECT UNITS</span>
  
  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B VIEWING GEOMETRIES: CONVERT VALUES INTO DEGREES'
  VIEW_GEO_SZA   = DOUBLE(VIEW_GEO_SZA)*DOUBLE(1e-6)
  VIEW_GEO_SAA   = DOUBLE(VIEW_GEO_SAA)*DOUBLE(1e-6)
  VIEW_GEO_VZA   = DOUBLE(VIEW_GEO_VZA)*DOUBLE(1e-6)
  VIEW_GEO_VAA   = DOUBLE(VIEW_GEO_VAA)*DOUBLE(1e-6)
  
<span class="comments">;---------------------------------------</span>
<span class="comments">; INTERPOLATE VALUES TO RADIANCE GRID</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B VIEWING GEOMETRIES: REGRID DATA INTO RADIANCE PRODUCT DIMENSIONS'
  VIEW_GEO_SZA   = CONGRID(VIEW_GEO_SZA,LINE_SIZE,NB_RD_LINE,/MINUS_ONE,/INTERP)
  VIEW_GEO_SAA   = CONGRID(VIEW_GEO_SAA,LINE_SIZE,NB_RD_LINE,/MINUS_ONE,/INTERP)
  VIEW_GEO_VZA   = CONGRID(VIEW_GEO_VZA,LINE_SIZE,NB_RD_LINE,/MINUS_ONE,/INTERP)
  VIEW_GEO_VAA   = CONGRID(VIEW_GEO_VAA,LINE_SIZE,NB_RD_LINE,/MINUS_ONE,/INTERP)
  
  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B VIEWING GEOMETRIES: RETURNING SZA,SAA,VZA,VAA'
  RETURN,{SZA:VIEW_GEO_SZA,SAA:VIEW_GEO_SAA,VZA:VIEW_GEO_VZA,VAA:VIEW_GEO_VAA}
  
END
</code>
    </div>
  </body>
</html>