<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Thu Jul  4 16:01:42 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>get_meris_lat_lon.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="get_meris_lat_lon.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;*</span>
<span class="comments">;* NAME:</span>
<span class="comments">;*      GET_MERIS_LAT_LON       </span>
<span class="comments">;* </span>
<span class="comments">;* PURPOSE:</span>
<span class="comments">;*      RETURNS THE LATITUDE AND LONGITUDE OF A MERIS IMAGE</span>
<span class="comments">;* </span>
<span class="comments">;* CALLING SEQUENCE:</span>
<span class="comments">;*      RES = GET_MERIS_LAT_LON(FILENAME)      </span>
<span class="comments">;* </span>
<span class="comments">;* INPUTS:</span>
<span class="comments">;*      FILENAME - A SCALAR CONTAINING THE FILENAME OF THE PRODUCT FOR GEOLOCAITON EXTRACTION      </span>
<span class="comments">;*</span>
<span class="comments">;* KEYWORDS:</span>
<span class="comments">;*      ENDIAN_SIZE - MACHINE ENDIAN SIZE (0: LITTLE, 1: BIG)</span>
<span class="comments">;*      VERBOSE     - PROCESSING STATUS OUTPUTS</span>
<span class="comments">;*</span>
<span class="comments">;* OUTPUTS:</span>
<span class="comments">;*      STRUCT.LAT  - LATITUDE IN DEGREES FOR L1B PRODUCT</span>
<span class="comments">;*      STRUCT.LON  - LONGITUDE IN DEGREES FOR L1B PRODUCT</span>
<span class="comments">;*      STRUCT.LAT_CORR - CORRECITON VALUE TO ACCOUNT FOR LAND ELEVATION 	</span>
<span class="comments">;*      STRUCT.LON_CORR - CORRECITON VALUE TO ACCOUNT FOR LAND ELEVATION</span>
<span class="comments">;*</span>
<span class="comments">;* COMMON BLOCKS:</span>
<span class="comments">;*      NONE</span>
<span class="comments">;*</span>
<span class="comments">;* MODIFICATION HISTORY:</span>
<span class="comments">;*      04 APR 2005 - M BOUVET - PROTOTYPE DIMITRI VERSION</span>
<span class="comments">;*      12 NOV 2010 - C KENT   - DIMITRI-2 V1.0</span>
<span class="comments">;*      20 NOV 2010 - C KENT   - UPDATED TO ALLOW SINGULAR USAGE (REMOVED COMMON BLOCKS)</span>
<span class="comments">;*      22 NOV 2010 - C KENT   - ADDED VERBOSE KEYWORD OPTION</span>
<span class="comments">;*      01 DEC 2010 - C KENT   - ADDED FILENAME ERROR HANDLING</span>
<span class="comments">;*      02 DEC 2010 - C KENT   - UPDATED HEADER INFORMATION</span>
<span class="comments">;*      23 DEC 2010 - C KENT   - CHANGED LAT LINE TO DOUBLE ARRAYS DUE TO DIFFERENCES </span>
<span class="comments">;*                               BETWEEN WINDOWS/LINUX</span>
<span class="comments">;*      12 SEP 2011 - C KENT   - UPDATED TO OUTPUT LAT_CORR AND LON_CORR VALUES</span>
<span class="comments">;*</span>
<span class="comments">;* VALIDATION HISTORY:</span>
<span class="comments">;*      01 DEC 2010 - C KENT   - WINDOWS 32-BIT MACHINE: COMPILATION SUCCESSFUL,</span>
<span class="comments">;*                               VERY SLIGHT DIFFERENCES TO BEAM VISAT (~0.0002 DEGREE)</span>
<span class="comments">;*      05 JAN 2010 - C KENT   - LINUX 64-BIT MACHINE IDL 8.0: COMPILATION SUCCESSFUL,</span>
<span class="comments">;*                               NO DIFFERENCES OBSERVED AGAINST WINDOWS 32-BIT MACHINE</span>
<span class="comments">;*</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

FUNCTION GET_MERIS_LAT_LON,FILENAME,ENDIAN_SIZE=ENDIAN_SIZE,VERBOSE=VERBOSE

<span class="comments">;------------------------------------------------</span>
<span class="comments">; CHECK FILENAME AND IN_BAND ARE NOMINAL</span>

  IF FILENAME EQ '' THEN BEGIN
    PRINT, 'MERIS L1B LAT LON: ERROR, INPUT FILENAME INCORRECT'
    RETURN,-1
  ENDIF
 
<span class="comments">;------------------------------------------------</span>
<span class="comments">; IF ENDIAN SIZE NOT PROVIDED THEN GET VALUE</span>

  IF N_ELEMENTS(ENDIAN_SIZE) EQ 0 THEN BEGIN
    IF KEYWORD_SET(VERBOSE) THEN BEGIN
    PRINT, 'MERIS L1B LAT LON: NO ENDIAN SIZE PROVIDED, RETRIEVING...'
    ENDIAN_SIZE = GET_ENDIAN_SIZE(/VERBOSE)
    ENDIF ELSE ENDIAN_SIZE = GET_ENDIAN_SIZE()
  ENDIF

<span class="comments">;------------------------------------------------</span>
<span class="comments">;DEFINE HEADER VARIABLES</span>

	MPH_SIZE = 1247
	SPH_SIZE = 9942
	FILE_MPH = BYTARR(MPH_SIZE)
	FILE_SPH = BYTARR(SPH_SIZE)

<span class="comments">;-----------------------------------------------</span>
<span class="comments">; OPEN THE FILE AND EXTRACT HEADER</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B LAT LON: OPENING PRODUCT'
	OPENR,PRD_GEO,FILENAME,/GET_LUN
	READU,PRD_GEO,FILE_MPH
	READU,PRD_GEO,FILE_SPH

<span class="comments">;-----------------------------------------------</span>
<span class="comments">; RETRIEVE: POSITION OF DSD, TP SUBSAMPLING FREQUENCY,LINE SIZE,TP PER LINE,DSD,OFFSET,DS_SIZE,NUMBER OF RECORDS, RECORD SIZE</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B LAT LON: RETRIEVING DSD INFORMATION'
  TP_POS =STRPOS(FILE_SPH,'DS_NAME="Tie points ADS              "')
  TP_SFREQ = STRMID(FILE_SPH, STRPOS(FILE_SPH,'SAMPLES_PER_TIE_PT=+')+20, 3)+0L
  LINE_SIZE =STRMID(FILE_SPH, STRPOS(FILE_SPH,'LINE_LENGTH=+')+13, 5)+0L
  NB_TP_LINE=FLOOR(LINE_SIZE/TP_SFREQ)+1

  TP_DSD=STRMID(FILE_SPH, TP_POS,280)
  TP_OFFSET = STRMID(TP_DSD, strpos(TP_DSD, 'DS_OFFSET=+')+11,20)+0L
  TP_SIZE = STRMID(TP_DSD, strpos(TP_DSD, 'DS_SIZE=+')+9,20)+0L
  TP_DSR_NUMBER = STRMID(TP_DSD, strpos(TP_DSD, 'NUM_DSR=+')+9,20)+0L
  TP_DSR_SIZE = STRMID(TP_DSD, strpos(TP_DSD, 'DSR_SIZE=+')+10,20)+0L

<span class="comments">;-----------------------------------------</span>
<span class="comments">; DEFINE LATITUDE AND LONGITUDE ARRAYS</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B LAT LON: DEFINING DATA ARRAYS FOR OUTPUT'
	LAT = LONARR(NB_TP_LINE,TP_DSR_NUMBER)
	LON = LONARR(NB_TP_LINE,TP_DSR_NUMBER)
  
  LAT_CORR = LONARR(NB_TP_LINE,TP_DSR_NUMBER)
  LON_CORR = LONARR(NB_TP_LINE,TP_DSR_NUMBER)

	LAT_REC = LONARR(NB_TP_LINE)
	LON_REC = LONARR(NB_TP_LINE)
	
	LAT_REC_CORR = LONARR(NB_TP_LINE)
	LON_REC_CORR = LONARR(NB_TP_LINE)
	
<span class="comments">;-----------------------------------------</span>
<span class="comments">; DEFINE NO DATA ARRAYS</span>

	NODATA1 = BYTARR(13)
	NODATA2 = LONARR(NB_TP_LINE)

<span class="comments">;-----------------------------------------</span>
<span class="comments">; LOOP OVER EACH RECORD AND EXTRACT GEOLOCATION DATA</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B LAT LON: STARTING LOOP FOR DATA EXTRACTION'
	FOR GREC=0,TP_DSR_NUMBER-1 DO BEGIN 

<span class="comments">;----------------------------------------</span>
<span class="comments">; POINT TO THE MDS WITHIN THE FILE</span>
		
		POINT_LUN, PRD_GEO, TP_OFFSET+GREC*TP_DSR_SIZE

<span class="comments">;----------------------------------------</span>
<span class="comments">; SKIP EMPTY BYTES</span>

		READU,PRD_GEO,NODATA1

<span class="comments">;----------------------------------------</span>
<span class="comments">; READ LATITUDE AND LONGITUDE RECORDS</span>

		READU,PRD_GEO,LAT_REC
		READU,PRD_GEO,LON_REC

<span class="comments">;----------------------------------------</span>
<span class="comments">; SKIP EMPTY BYTES</span>

		READU,PRD_GEO,NODATA2
		READU,PRD_GEO,NODATA2

<span class="comments">;----------------------------------------</span>
<span class="comments">; READ LATITUDE AND LONGITUDE CORRECTIONS</span>

		READU,PRD_GEO,LAT_REC_CORR
		READU,PRD_GEO,LON_REC_CORR
	
<span class="comments">;----------------------------------------</span>
<span class="comments">; SWAP ENDIAN IF NEEDED - MERIS DATA IS BIG ENDIAN</span>
	
		IF ENDIAN_SIZE EQ 0 THEN BEGIN
		
			LAT_REC		= SWAP_ENDIAN(LAT_REC)
			LON_REC		= SWAP_ENDIAN(LON_REC)
			LAT_REC_CORR	= SWAP_ENDIAN(LAT_REC_CORR)
			LON_REC_CORR	= SWAP_ENDIAN(LON_REC_CORR)
		
		ENDIF
	
<span class="comments">;---------------------------------------</span>
<span class="comments">; STORE EXTRACTED DATA -20110912 removed section - lat, lat_corr, lon and lon_corr will now be returned from function</span>

<span class="comments">;		LAT(*,GREC)=double(LAT_REC)+double(LAT_REC_CORR)</span>
<span class="comments">;		LON(*,GREC)=double(LON_REC)+double(LON_REC_CORR)</span>
  
  LAT(*,GREC)=DOUBLE(LAT_REC)
  LON(*,GREC)=DOUBLE(LON_REC)
  LAT_CORR(*,GREC)=DOUBLE(LAT_REC_CORR)
  LON_CORR(*,GREC)=DOUBLE(LON_REC_CORR)  
 
	ENDFOR <span class="comments">;END OF LOOP ON GEOLOCATION RECORDS</span>

<span class="comments">;---------------------------------------</span>
<span class="comments">; CLOSE THE FILE</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B LAT LON: CLOSING PRODUCTS AND RELEASING THE LUN'
	CLOSE, PRD_GEO
	FREE_LUN, PRD_GEO

<span class="comments">;---------------------------------------</span>
<span class="comments">; FIND NUMBER OF PIXELS WITHIN MERIS RADIANCE FRAME</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B LAT LON: RETRIEVE DIMENSIONS OF RADIANCE PRODUCT'
	RD_POS 		  = STRPOS(FILE_SPH,'DS_NAME="Radiance MDS(1)             "')
	RD_DSD 		  = STRMID(FILE_SPH, RD_POS,280)
	NB_RD_LINE 	= STRMID(RD_DSD, STRPOS(RD_DSD, 'NUM_DSR=+')+9,20)

<span class="comments">;---------------------------------------</span>
<span class="comments">; CONVERT VALUES INTO DEGREES</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B LAT LON: CONVERT VALUES INTO DEGREES'
	LAT = DOUBLE(LAT)*DOUBLE(1E-6)
	LON = DOUBLE(LON)*DOUBLE(1E-6)
  LAT_CORR = DOUBLE(LAT_CORR)*DOUBLE(1E-6)
  LON_CORR = DOUBLE(LON_CORR)*DOUBLE(1E-6)

<span class="comments">;---------------------------------------</span>
<span class="comments">; INTERPOLATE VALUES TO RADIANCE GRID</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B LAT LON: REGRID DATA INTO RADIANCE PRODUCT DIMENSIONS'
	LAT = CONGRID(LAT,LINE_SIZE,NB_RD_LINE,/MINUS_ONE,/INTERP)
	LON = CONGRID(LON,LINE_SIZE,NB_RD_LINE,/MINUS_ONE,/INTERP)
  LAT_CORR = CONGRID(LAT_CORR,LINE_SIZE,NB_RD_LINE,/MINUS_ONE,/INTERP)
  LON_CORR = CONGRID(LON_CORR,LINE_SIZE,NB_RD_LINE,/MINUS_ONE,/INTERP)

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'MERIS L1B LAT LON: RETURNING LATITUDE AND LONGITUDE'
	RETURN,{LAT:LAT,LON:LON,LAT_CORR:LAT_CORR,LON_CORR:LON_CORR}

END
</code>
    </div>
  </body>
</html>