<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Thu Jul  4 16:01:57 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>vgtextract.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="vgtextract.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><a id="vgtextract:source"></a>pro vgtextract

<span class="comments">;assumes all data has been extracted using vgt extract</span>

<span class="comments">;define initial parameters</span>
case strupcase(!version.os_family) of
'WINDOWS': begin
base_ofolder = 'E:\VGT_extract\'
dl = '\'
base_ifolder = 'E:\VGT_extract\'
end
'UNIX':begin
base_ofolder = '/mnt/Projects/MEREMSII/VGT_Data/ESA_BOUSSOLE/'
dl = '/'
base_ifolder = '/mnt/USB_drive02/VEGETATION/boussole/freeP/v2/'
end
endcase
<span class="comments">;3,0,-58,-55</span>
icoords      = [ 44.45         ,         42.25,         9.0,         6.8]
new_geo_str1 = ['  44.450000' ,'  42.250000','   9.000000','   6.800000']
new_geo_str2 = ['+044.450000' ,'+042.250000','+009.000000','+006.800000']
new_geo_str3 = ['  43.350000' ,'   7.900000','   2.250000','   2.200000']

<span class="comments">;search for all files within output folder</span>
cd,current=cdir
cd,base_ofolder
all_files = file_search('*.hdf')
all_files_short = strmid(all_files,0,22)

<span class="comments">;get a list of all uniq products</span>
uniq_files_short = all_files_short[uniq(all_files_short,sort(all_files_short))]

<span class="comments">;loop over each uniq product</span>
for i=0l,n_elements(uniq_files_short)-1 do begin

print, '>>>> Iteration : ',strtrim(i,2),' out of ',strtrim(n_elements(uniq_files_short)-1,2)

<span class="comments">; create a new folder to keep all the products - if it already exists then skip it</span>
new_folder = base_ofolder+uniq_files_short[i]
if file_test(new_folder,/directory) eq 1 then goto, skip_extract

file_mkdir,new_folder
new_folder = new_folder+dl+'0001'
file_mkdir,new_folder

<span class="comments">; move all the extracted products to the new folder</span>
str = uniq_files_short[i]+'*'
res = file_search(base_ofolder,str)
for j=1l,n_elements(res)-1 do begin
temp_file = res[j]
pos = strpos(temp_file,'ZIP')
pos2 = strpos(temp_file,'_20',/reverse_search)
new_file = '0001_'+strmid(temp_file,pos+4,pos2-pos-4)+'.HDF'
file_copy,res[j],new_folder+dl+new_file,/overwrite
<span class="comments">;file_delete,res[j]geo_locatin</span>
endfor

<span class="comments">; find the original zip file</span>
tempf = strmid(uniq_files_short[i],10,4)+dl+strmid(uniq_files_short[i],14,2)+dl+strmid(uniq_files_short[i],16,2)
original_zip_folder = base_ifolder+tempf
original_zip = file_search(original_zip_folder,str)

<span class="comments">; read one of the old reflectance products and get dimensions</span>
<span class="comments">;unzip the old file</span>
<span class="comments">; read the log file</span>
<span class="comments">;delete all products but the zip file</span>
cd,current=cdir
cd,original_zip_folder
if strupcase(!version.os_family) eq 'WINDOWS' then spawn,string('7z e -aoa '+original_zip[0]) $ 
  else spawn,string('7za e -aoa '+original_zip[0])
cd,cdir
extract_folder = original_zip_folder+dl
original_log = extract_folder+'0001_LOG.TXT'
<span class="comments">;original_reflectance = GET_VEGETATION_L1B_REFLECTANCE(original_log) </span>
<span class="comments">; read one of the old reflectance products and get dimensions</span>
original_geo_location = GET_VEGETATION_LAT_LON(original_log)

lat_row = where(original_geo_location.lat[0,*] lt icoords[0] and original_geo_location.lat[0,*] gt icoords[1])
lon_col = where(original_geo_location.lon[*,0] lt icoords[2] and original_geo_location.lon[*,0] gt icoords[3])

if lat_row[0] eq -1 or  lon_col[0] eq -1 then goto, no_cord


new_lat_indexes = [lat_row[0],lat_row[n_elements(lat_row)-1]]
new_lon_indexes = [lon_col[0],lon_col[n_elements(lon_col)-1]]


log_data = string(read_binary(original_log))

<span class="comments">; replace the lon/lat with site lon/lat</span>
POS = STRPOS(log_data,'CARTO_UPPER_LEFT_X')
strput,log_data,new_geo_str1[3],pos+26
POS = STRPOS(log_data,'CARTO_UPPER_LEFT_Y')
strput,log_data,new_geo_str1[0],pos+26
POS = STRPOS(log_data,'CARTO_UPPER_RIGHT_X')
strput,log_data,new_geo_str1[2],pos+26
POS = STRPOS(log_data,'CARTO_UPPER_RIGHT_Y')
strput,log_data,new_geo_str1[0],pos+26
POS = STRPOS(log_data,'CARTO_LOWER_RIGHT_X')
strput,log_data,new_geo_str1[2],pos+26
POS = STRPOS(log_data,'CARTO_LOWER_RIGHT_Y')
strput,log_data,new_geo_str1[1],pos+26
POS = STRPOS(log_data,'CARTO_LOWER_LEFT_X')
strput,log_data,new_geo_str1[3],pos+26
POS = STRPOS(log_data,'CARTO_LOWER_LEFT_Y')
strput,log_data,new_geo_str1[1],pos+26

POS = STRPOS(log_data,'CARTO_CENTER_X')
strput,log_data,new_geo_str3[1],pos+26
POS = STRPOS(log_data,'CARTO_CENTER_Y')
strput,log_data,new_geo_str3[0],pos+26
POS = STRPOS(log_data,'CARTO_HEIGHT')
strput,log_data,new_geo_str3[2],pos+26
POS = STRPOS(log_data,'CARTO_WIDTH')
strput,log_data,new_geo_str3[3],pos+26

POS = STRPOS(log_data,'GEO_UPPER_LEFT_LAT')
strput,log_data,new_geo_str2[0],pos+26
POS = STRPOS(log_data,'GEO_UPPER_LEFT_LON')
strput,log_data,new_geo_str2[3],pos+26
POS = STRPOS(log_data,'GEO_UPPER_RIGHT_LAT')
strput,log_data,new_geo_str2[0],pos+26
POS = STRPOS(log_data,'GEO_UPPER_RIGHT_LON')
strput,log_data,new_geo_str2[2],pos+26
POS = STRPOS(log_data,'GEO_LOWER_RIGHT_LAT')
strput,log_data,new_geo_str2[1],pos+26
POS = STRPOS(log_data,'GEO_LOWER_RIGHT_LON')
strput,log_data,new_geo_str2[2],pos+26
POS = STRPOS(log_data,'GEO_LOWER_LEFT_LAT')
strput,log_data,new_geo_str2[1],pos+26
POS = STRPOS(log_data,'GEO_LOWER_LEFT_LON')
strput,log_data,new_geo_str2[3],pos+26


POS1 = STRPOS(log_data,'IMAGE_UPPER_RIGHT_COL')    
POS2 = STRPOS(log_data,'IMAGE_LOWER_RIGHT_ROW') 
POS3 = STRPOS(log_data,'IMAGE_LOWER_RIGHT_COL')
POS4 = STRPOS(log_data,'IMAGE_LOWER_LEFT_ROW')
POS5 = STRPOS(log_data,'IMAGE_LOWER_LEFT_COL')
pos6 = STRPOS(log_data,'IMAGE_CENTER_ROW')
pos7 = STRPOS(log_data,'IMAGE_CENTER_COL')
pos8 = STRPOS(log_data,'GEOM_CHAR_REF')
size_1 = pos2-pos1-26
size_2 = pos3-pos2-26
size_3 = pos7-pos6-26
size_4 = pos8-pos7-26

tt = strtrim(string(fix(2+new_lat_indexes[1]-new_lat_indexes[0])),2)
ttt = strjoin([tt,make_array(size_2-strlen(tt),value=' '),string(10b)])

ll = strtrim(string(fix(2+new_lon_indexes[1]-new_lon_indexes[0])),2) 
lll= strjoin([ll,make_array(size_1-strlen(ll),value=' '),string(10b)])

trow = fix(ttt)/2
trow= strjoin([strtrim(string(trow),2),make_array(size_1-strlen(strtrim(string(trow),2)),value=' '),string(10b)])
tcol = fix(lll)/2
tcol= strjoin([strtrim(string(tcol),2),make_array(size_2-strlen(strtrim(string(tcol),2)),value=' '),string(10b)])

p1 = strmid(log_data,0,pos1+26)
p2 = strmid(log_data,pos2,26)
p3 = strmid(log_data,pos3,26)
p4 = strmid(log_data,pos4,26)
p5 = strmid(log_data,pos5,pos6-pos5)
p6 = strmid(log_data,pos6,26)
p7 = strmid(log_data,pos7,26)
p8 = strmid(log_data,pos8,strlen(log_data)-pos8)

log_data = strjoin([p1,lll,p2,ttt,p3,lll,p4,ttt,p5,p6,trow,p7,tcol,p8])

new_log = new_folder+dl+'0001_LOG.TXT'
openw,lun,new_log,/get_lun
printf,lun,log_data
free_lun,lun

<span class="comments">; open the orinal og,ag and wvp products</span>

  i_dat = [extract_folder+'0001_AG.HDF',extract_folder+'0001_OG.HDF',extract_folder+'0001_WVG.HDF']
  o_dat = [new_folder+dl+'0001_AG.HDF',new_folder+dl+'0001_OG.HDF',new_folder+dl+'0001_WVG.HDF']
  
  for jj=0l,2 do begin
  hdfid = HDF_SD_START(i_dat[jj], /read)
  sd_id = HDF_SD_SELECT(hdfid,0)
  HDF_SD_GETDATA, sd_id, data
  HDF_SD_ENDACCESS, sd_id
  HDF_SD_END, hdfid
  dims = size(data)

  interpolated_data = rebin(data,dims(1)*100,dims(2)*100)
  y_r=100.*ceil((2+new_lat_indexes[1]-new_lat_indexes[0])/100.)
  x_r=100.*ceil((2+new_lon_indexes[1]-new_lon_indexes[0])/100.)
  extract_data = interpolated_data[new_lon_indexes[0]:new_lon_indexes[0]+x_r,new_lat_indexes[0]:new_lat_indexes[0]+y_r]
  
  rebin_data = congrid(extract_data,x_r/100,y_r/100)
  hdfid = HDF_SD_START(o_dat[jj], /create)
  SD_id = HDF_SD_CREATE(hdfid, 'MEASURE VALUE',[x_r/100,y_r/100])
  HDF_SD_ADDDATA, SD_id, rebin_data 
  HDF_SD_ENDACCESS, sd_id
  HDF_SD_END, hdfid
  endfor

<span class="comments">;extract the correct  angular data</span>

  i_dat = [extract_folder+'0001_SZA.HDF',extract_folder+'0001_SAA.HDF',extract_folder+'0001_VZA.HDF',extract_folder+'0001_VAA.HDF']
  o_dat = [new_folder+dl+'0001_SZA.HDF',new_folder+dl+'0001_SAA.HDF',new_folder+dl+'0001_VZA.HDF',new_folder+dl+'0001_VAA.HDF']
  
  for jj=0l,3 do begin
  
  IF FILE_TEST(O_dat[jj]) EQ 1 THEN FILE_DELETE,O_dat[jj]
  hdfid = HDF_SD_START(i_dat[jj], /read)
  sd_id = HDF_SD_SELECT(hdfid,0)
  HDF_SD_GETDATA, sd_id, data
  HDF_SD_ENDACCESS, sd_id
  HDF_SD_END, hdfid
  dims = size(data)

  interpolated_data = rebin(data,dims(1)*8,dims(2)*8)
  y_r=8.*ceil((2+new_lat_indexes[1]-new_lat_indexes[0])/8.) &lt<span class="comments">; dims(2)*8-1</span>
  x_r=8.*ceil((2+new_lon_indexes[1]-new_lon_indexes[0])/8.) &lt<span class="comments">; dims(1)*8-1</span>
  
  TOPVALY = new_lat_indexes[0]+y_r &lt<span class="comments">; dims(2)*8-1</span>
  TOPVALX = new_lon_indexes[0]+x_r &lt<span class="comments">; dims(1)*8-1</span>
  
  extract_data = interpolated_data[new_lon_indexes[0]:TOPVALX,new_lat_indexes[0]:TOPVALY]
  
  rebin_data = congrid(extract_data,(x_r/8)>1,(y_r/8)>1)
  hdfid = HDF_SD_START(o_dat[jj], /create)
  SD_id = HDF_SD_CREATE(hdfid, 'ANGLES_VALUES',[(x_r/8)>1,(y_r/8)>1])
  HDF_SD_ADDDATA, SD_id, rebin_data 
  HDF_SD_ENDACCESS, sd_id
  HDF_SD_END, hdfid
  endfor

<span class="comments">; copy the rig file across to new folder</span>
  file_copy,extract_folder+'0001_RIG.TXT',new_folder+dl+'0001_RIG.TXT',/overwrite

no_cord:

<span class="comments">; find all hdf files and delete</span>
files_for_deletion = file_search(original_zip_folder,'*.hdf')
for kk=0,n_elements(files_for_deletion)-1 do file_delete,files_for_deletion[kk]

skip_extract:

endfor
print, 'finished'
<span class="comments">;need to delete unzipped files?</span>

<span class="comments">;</span>
<span class="comments">;</span>
<span class="comments">;;for a given file</span>
<span class="comments">;file = 'C:\Documents and Settings\Christopher\Desktop\VGT_extract\V2KRNP____20090102F025.ZIP'</span>
<span class="comments">;output_folder = 'C:\Documents and Settings\Christopher\Desktop\VGT_extract\chris_extract\'</span>
<span class="comments">;icoords      = [44.56         ,        44.00,         10.0,          8.0]</span>
<span class="comments">;new_geo_str1 = ['  44.560000' ,'  44.000000','  10.000000','   8.000000']</span>
<span class="comments">;new_geo_str2 = ['+044.560000' ,'+044.000000','+010.000000','+008.000000']</span>
<span class="comments">;new_geo_str3 = ['  44.280000' ,'   9.000000','   0.560000','   2.000000']</span>
<span class="comments">;</span>
<span class="comments">;res=file_info(output_folder)</span>
<span class="comments">;if res.exists eq 0 then file_mkdir,output_folder</span>
<span class="comments">;</span>
<span class="comments">;;unzip the zip product</span>
<span class="comments">;;spawn,string('unzip -n '+file)</span>
<span class="comments">;</span>
<span class="comments">;product_names = ['AG.HDF','B0.HDF','B2.HDF','B3.HDF','MIR.HDF','OG.HDF','RIG.TXT','SAA.HDF',$</span>
<span class="comments">;                  'SM.HDF','SZA.HDF','VAA.HDF','VZA.HDF','WVG.HDF']</span>
<span class="comments">;proc_typ = [2,1,1,1,1,2,0,1,1,1,1,1,2]</span>
<span class="comments">;</span>
<span class="comments">;;sort out log file</span>
<span class="comments">;log_data = string(read_binary('0001_LOG.TXT'))</span>
<span class="comments">;POS = STRPOS(log_data,'CARTO_UPPER_LEFT_X')</span>
<span class="comments">;</span>
<span class="comments">;strput,log_data,new_geo_str1[3],pos+0*37</span>
<span class="comments">;strput,log_data,new_geo_str1[0],pos+1*37</span>
<span class="comments">;strput,log_data,new_geo_str1[2],pos+2*37</span>
<span class="comments">;strput,log_data,new_geo_str1[0],pos+3*37</span>
<span class="comments">;strput,log_data,new_geo_str1[2],pos+4*37</span>
<span class="comments">;strput,log_data,new_geo_str1[1],pos+5*37</span>
<span class="comments">;strput,log_data,new_geo_str1[3],pos+6*37</span>
<span class="comments">;strput,log_data,new_geo_str1[1],pos+7*37</span>
<span class="comments">;</span>
<span class="comments">;strput,log_data,new_geo_str3[1],pos+8*37</span>
<span class="comments">;strput,log_data,new_geo_str3[0],pos+9*37</span>
<span class="comments">;strput,log_data,new_geo_str3[2],pos+10*37</span>
<span class="comments">;strput,log_data,new_geo_str3[3],pos+11*37</span>
<span class="comments">;</span>
<span class="comments">;strput,log_data,new_geo_str2[0],pos+12*37</span>
<span class="comments">;strput,log_data,new_geo_str2[3],pos+13*37</span>
<span class="comments">;strput,log_data,new_geo_str2[0],pos+14*37</span>
<span class="comments">;strput,log_data,new_geo_str2[2],pos+15*37</span>
<span class="comments">;strput,log_data,new_geo_str2[1],pos+16*37</span>
<span class="comments">;strput,log_data,new_geo_str2[2],pos+17*37</span>
<span class="comments">;strput,log_data,new_geo_str2[1],pos+18*37</span>
<span class="comments">;strput,log_data,new_geo_str2[3],pos+19*37</span>
<span class="comments">;</span>
<span class="comments">;;find index of pixels to be extracted using geolocation</span>
<span class="comments">;;loop over each extracted file</span>
<span class="comments">;; read the products data</span>
<span class="comments">;; extract data pixels as identified by geo check</span>
<span class="comments">;; save data back as another hdf file in output folder</span>
<span class="comments">;; if ag, wvg or og then interpolate to main product grid, extract geo pixels, and rebin/regrid it back to the reduxed resolution grid</span>
<span class="comments">;; endloop</span>
<span class="comments">;; copy log file and update coordinates to geo location</span>
<span class="comments">;</span>




end




</code>
    </div>
  </body>
</html>