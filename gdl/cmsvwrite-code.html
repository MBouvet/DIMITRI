<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Tue Jul  2 12:50:48 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>cmsvwrite.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="cmsvwrite.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;   CMSVWRITE</span>
<span class="comments">;</span>
<span class="comments">; AUTHOR:</span>
<span class="comments">;   Craig B. Markwardt, NASA/GSFC Code 662, Greenbelt, MD 20770</span>
<span class="comments">;   craigm@lheamail.gsfc.nasa.gov</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;   Write a single variable to an open SAVE file</span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;</span>
<span class="comments">;   CMSVWRITE, UNIT, DATA [ , NAME=NAME, COMPATIBILITY=COMPAT ]</span>
<span class="comments">;   </span>
<span class="comments">; DESCRIPTION: </span>
<span class="comments">;</span>
<span class="comments">;   CMSVWRITE writes a single IDL variable to an open IDL SAVE file.</span>
<span class="comments">;   The file should already have been opened for writing as a normal</span>
<span class="comments">;   file using OPENW or OPENU.</span>
<span class="comments">;</span>
<span class="comments">;   CMSVWRITE is a simplified version of the CMSVLIB package, and as</span>
<span class="comments">;   such is not capable of writing heap data (pointers) or object</span>
<span class="comments">;   data, or structures that contain them.  Strings, structures, and</span>
<span class="comments">;   all array types are supported.</span>
<span class="comments">;</span>
<span class="comments">;   This procedure is part of the CMSVLIB SAVE library for IDL by</span>
<span class="comments">;   Craig Markwardt.  You must have the full CMSVLIB core package</span>
<span class="comments">;   installed in order for this procedure to function properly.</span>
<span class="comments">;</span>
<span class="comments">; ==================================================================</span>
<span class="comments">;   Research Systems, Inc. has issued a separate license intended</span>
<span class="comments">;   to resolve any potential conflict between this software and the</span>
<span class="comments">;   IDL End User License Agreement. The text of that license</span>
<span class="comments">;   can be found in the file LICENSE.RSI, included with this</span>
<span class="comments">;   software library.</span>
<span class="comments">; ==================================================================</span>
<span class="comments">;</span>
<span class="comments">; INPUTS:</span>
<span class="comments">;</span>
<span class="comments">;   UNIT - the open file unit.</span>
<span class="comments">;</span>
<span class="comments">;   DATA - the data to be written.</span>
<span class="comments">;</span>
<span class="comments">; KEYWORDS:</span>
<span class="comments">;</span>
<span class="comments">;   NAME - the optional name of the variable to be written (must be a</span>
<span class="comments">;          valid variable name).</span>
<span class="comments">;          Default: CMSVWRITE automatically creates a valid name.</span>
<span class="comments">;  </span>
<span class="comments">;   COMPATIBILITY - a string, which describes the format to be used in</span>
<span class="comments">;          the output file.  Possible values are:</span>
<span class="comments">;</span>
<span class="comments">;                  'IDL4' - format of IDL version 4;</span>
<span class="comments">;                  'IDL5' - format of IDL versions 5.0-5.3;</span>
<span class="comments">;                  'IDL6' - not supported yet, for versions 5.4-above;</span>
<span class="comments">;                  'RIVAL1' - same as 'IDL5'</span>
<span class="comments">;           Note that files written in IDL5 format may still be</span>
<span class="comments">;           readable by IDL v.4.</span>
<span class="comments">;           Default: 'IDL5'</span>
<span class="comments">;</span>
<span class="comments">;   NO_END - a save file must terminate with an "end" record.  By</span>
<span class="comments">;            default, CMSVWRITE will append such a record after the</span>
<span class="comments">;            variable is written, and then rewind the file pointer.</span>
<span class="comments">;            The end record must be written after the last variable,</span>
<span class="comments">;            but is optional otherwise.  Set this keyword to disable</span>
<span class="comments">;            writing the end record (for performance reasons).</span>
<span class="comments">;</span>
<span class="comments">;   QUIET - if set, error messages are not printed.</span>
<span class="comments">;           Default: an error causes errors to be printed with MESSAGE</span>
<span class="comments">;</span>
<span class="comments">;   STATUS - upon return, this keyword will contain 1 for success and</span>
<span class="comments">;            0 for failure.</span>
<span class="comments">;</span>
<span class="comments">;   ERRMSG - upon return with a failure, this keyword will contain the</span>
<span class="comments">;            error condition as a string.</span>
<span class="comments">;</span>
<span class="comments">; EXAMPLE:</span>
<span class="comments">;</span>
<span class="comments">;   Write variables A, B, C and D to a file.</span>
<span class="comments">;</span>
<span class="comments">;   openw, 50, 'test.sav'       ;; Add /STREAM under VMS !</span>
<span class="comments">;   cmsvwrite, 50, a, name='a'</span>
<span class="comments">;   cmsvwrite, 50, b, name='b'</span>
<span class="comments">;   cmsvwrite, 50, c, name='c'</span>
<span class="comments">;   close, 50</span>
<span class="comments">;</span>
<span class="comments">; SEE ALSO:</span>
<span class="comments">;</span>
<span class="comments">;   CMSVREAD, CMRESTORE, CMSAVE, SAVE, CMSVLIB</span>
<span class="comments">;</span>
<span class="comments">; MODIFICATION HISTORY:</span>
<span class="comments">;   Written and documented, 11 Jan 2001, CM</span>
<span class="comments">;   Make version checks with correct precision, 19 Jul 2001, CM</span>
<span class="comments">;   Added notification about RSI License, 13 May 2002, CM</span>
<span class="comments">;   NOTE: remember to modify CMSVLIB.PRO when changing library!</span>
<span class="comments">;</span>
<span class="comments">; $Id: cmsvwrite.pro,v 1.12 2009/11/22 22:50:49 craigm Exp $</span>
<span class="comments">;</span>
<span class="comments">;-</span>
<span class="comments">; Copyright (C) 2001, Craig Markwardt</span>
<span class="comments">; This software is provided as is without any warranty whatsoever.</span>
<span class="comments">; Permission to use, copy, modify, and distribute modified or</span>
<span class="comments">; unmodified copies is granted, provided this copyright and disclaimer</span>
<span class="comments">; are included unchanged.</span>
<span class="comments">;-</span>
<a id="cmsvwrite:source"></a>pro cmsvwrite, unit0, data, name=name0, compat=compat0, no_end=noend, $
               quiet=quiet, status=status, errmsg=errmsg

  status = 0
  catch, catcherr
  if catcherr EQ 0 then lib = cmsvlib(/query) else lib = 0
  catch, /cancel
  if lib EQ 0 then begin
      errmsg = 'ERROR: The CMSVLIB library must be in your IDL path.'
      if keyword_set(quiet) then return else message, errmsg
  endif

  if n_elements(compat0) EQ 0 then compat = 'IDL5' $
  else                             compat = strtrim(compat0,2)

  if compat NE 'IDL4' AND compat NE 'IDL5' AND compat NE 'IDL6' AND $
    compat NE 'RIVAL1' then begin
      errmsg = 'ERROR: unrecognized COMPAT value'
  endif
    
  <span class="comments">;; Do type checking on the data</span>
  if n_elements(data) EQ 0 then begin
      errmsg = 'ERROR: DATA must be defined'
      if keyword_set(quiet) then return else message, errmsg
  endif

  if double(!version.release) GT 4D then begin
      has_objects = 0
      cmsv_ptrsum, null, /null
      cmsv_ptrsum, data, pheap, has_objects=has_objects

      if n_elements(pheap) GT 1 then goto, PTR_ERROR
      if pheap(0) NE null OR has_objects then begin
          PTR_ERROR:
          errmsg =  'ERROR: CMSVWRITE cannot save pointers or objects'
          if keyword_set(quiet) then return else message, errmsg
      endif
  endif

  if n_elements(unit0) EQ 0 then begin
      errmsg = 'ERROR: UNIT is not defined'
      if keyword_set(quiet) then return else message, errmsg
  endif
  unit = floor(unit0(0))

  stat = fstat(unit)
  if stat.write EQ 0 OR stat.open EQ 0 then begin
      errmsg = 'ERROR: UNIT is not open for writing'
      if keyword_set(quiet) then return else message, errmsg
  endif

  <span class="comments">;; We are at the beginning of the file, make sure this is a proper</span>
  <span class="comments">;; IDL save file.</span>
  if stat.cur_ptr EQ 0 then begin
      <span class="comments">;; Open the file</span>
      cmsv_open, unit, 'FILENAME', off0, access='W', /reopen, $
        status=status, errmsg=errmsg
      if status EQ 0 then begin
          if keyword_set(quiet) then return else message, errmsg
      endif

      <span class="comments">;; Write the opening records which establish the version number</span>
      <span class="comments">;; and time stamp.</span>
      pp = 0L
      cmsv_wrec, block, pp, block_name='TIMESTAMP', offset=off0, $
        status=status, errmsg=errmsg
      if (status NE 0) AND (compat NE 'IDL4') then $
        cmsv_wrec, block, pp, block_name='VERSION', offset=off0, $
        compat=compat, status=status, errmsg=errmsg
      if status EQ 0 then begin
          if keyword_set(quiet) then return else message, errmsg
      endif


      <span class="comments">;; Write the block</span>
      writeu, unit, block(0:pp-1)
  endif
  point_lun, -unit, off0

  <span class="comments">;; Construct a name for this variable, if one wasn't provided</span>
  if n_elements(name0) EQ 0 then begin
      DEFAULT_NAME:
      name = string(off0, format='("CMSV_",Z8.8)')
  endif else begin
      name = strupcase(strtrim(name0(0),2))
      if name EQ '' then goto, DEFAULT_NAME
  endelse

  pp = 0L
  block = 0 & dummy = temporary(block)

  <span class="comments">;; Make a block and write out the variable type and data.  The</span>
  <span class="comments">;; following procedure is required.  First, we create a new block,</span>
  <span class="comments">;; which establishes the header and record type (VARIABLE).  Second</span>
  <span class="comments">;; we write out the variable type.  Finally we write the actual</span>
  <span class="comments">;; data, and call the "finblock" procedure which rewrites the header</span>
  <span class="comments">;; record to have the correct "next" pointer.</span>
  <span class="comments">;; </span>
  <span class="comments">;; Note that all these procedures write to a block in memory first,</span>
  <span class="comments">;; and only at the end is the block written to disk.</span>
  sz = size(data)
  off1 = pp
  cmsv_wrec, block, pp, data, name, block_name='VARIABLE', $
    /init, offset=off0, $
    status=status, errmsg=errmsg
  if status EQ 0 then begin
      if keyword_set(quiet) then return else message, errmsg
  endif

  <span class="comments">;; Now write out an end marker block, which will serve to terminate</span>
  <span class="comments">;; the file in case the user closes it.  We will rewind to this</span>
  <span class="comments">;; point in case new writes occur, so they will overwrite the end</span>
  <span class="comments">;; block.</span>

  eoff = off0 + pp
  if NOT keyword_set(noend) then begin
      cmsv_wrec, block, pp, block_name='END_MARKER', offset=off0, $
        status=status, errmsg=errmsg
      if status EQ 0 then begin
          if keyword_set(quiet) then return else message, errmsg
      endif
  endif

  writeu, unit, block(0:pp-1)
  block = 0
  
  <span class="comments">;; Now rewind the file pointer so that it points at the end marker.</span>
  <span class="comments">;; Any new writes will overwrite the marker.</span>
  if NOT keyword_set(noend) then point_lun, unit, eoff

  status = 1
  return
end
</code>
    </div>
  </body>
</html>