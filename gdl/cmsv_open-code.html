<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Tue Jul  2 12:50:46 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>cmsv_open.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="cmsv_open.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;   CMSV_OPEN</span>
<span class="comments">;</span>
<span class="comments">; AUTHOR:</span>
<span class="comments">;   Craig B. Markwardt, NASA/GSFC Code 662, Greenbelt, MD 20770</span>
<span class="comments">;   craigm@lheamail.gsfc.nasa.gov</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;   Open IDL SAVE file for reading or writing</span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;   CMSV_OPEN, UNIT, FILENAME, OFFSET, $</span>
<span class="comments">;          ACCESS=ACCESS, /FORCE, /GET_LUN, /REOPEN, $</span>
<span class="comments">;          COMPATIBILITY=COMPATIBILITY, $</span>
<span class="comments">;          STATUS=STATUS, ERRMSG=ERRMSG</span>
<span class="comments">;   </span>
<span class="comments">; DESCRIPTION: </span>
<span class="comments">;</span>
<span class="comments">;   CMSV_OPEN opens an IDL SAVE-formatted file for reading or writing.</span>
<span class="comments">;   The mode of operation is controlled by the ACCESS keyword, which</span>
<span class="comments">;   may be either 'R' for reading, 'W' for writing, or 'RW' for</span>
<span class="comments">;   read/write access.</span>
<span class="comments">;</span>
<span class="comments">;   'R': In the case of reading, the specified file is opened with</span>
<span class="comments">;   read-only access, and the first bytes are examined to verify that</span>
<span class="comments">;   it is indeed a valid IDL SAVE file.  </span>
<span class="comments">;</span>
<span class="comments">;   'W': In the case of writing, the specified file is opened with</span>
<span class="comments">;   write access, and the initial file signature is written.  </span>
<span class="comments">;</span>
<span class="comments">;   'RW': In the case of read-write access, the file must already</span>
<span class="comments">;   exist as a valid SAVE file.  Users are advised that every time</span>
<span class="comments">;   they switch between reading and writing operations, they must use</span>
<span class="comments">;   POINT_LUN to flush the file buffers.</span>
<span class="comments">;</span>
<span class="comments">;   The CMSVLIB routines do not support file sizes greater than 2 GB,</span>
<span class="comments">;   nor SAVE files created with the COMPRESS option.</span>
<span class="comments">;</span>
<span class="comments">;   Upon return, the file pointer is positioned at the start of the</span>
<span class="comments">;   first valid SAVE record.  The file offset is returned in OFFSET.</span>
<span class="comments">;   The user is responsible for reading or writing the remainder of</span>
<span class="comments">;   the file with other library routines.</span>
<span class="comments">;</span>
<span class="comments">;   The file unit is determined based on the following criteria.  This</span>
<span class="comments">;   behavior is similar to the OPEN family of procedures, except for</span>
<span class="comments">;   the REOPEN keyword.</span>
<span class="comments">;</span>
<span class="comments">;     * If REOPEN is set then it is assumed that UNIT is an</span>
<span class="comments">;       already-open file, and FILENAME is ignored.  </span>
<span class="comments">;</span>
<span class="comments">;     * If GET_LUN is set then a file unit is allocated with GET_LUN,</span>
<span class="comments">;       and upon success this unit is returned in UNIT.</span>
<span class="comments">;</span>
<span class="comments">;     * Otherwise it is asssumed that UNIT is a valid but unopened</span>
<span class="comments">;       file unit.  Upon successful return, UNIT is opened.</span>
<span class="comments">;</span>
<span class="comments">;   This procedure is part of the CMSVLIB SAVE library for IDL by</span>
<span class="comments">;   Craig Markwardt.  You must have the full CMSVLIB core package</span>
<span class="comments">;   installed in order for this procedure to function properly.</span>
<span class="comments">;</span>
<span class="comments">; ==================================================================</span>
<span class="comments">;   Research Systems, Inc. has issued a separate license intended</span>
<span class="comments">;   to resolve any potential conflict between this software and the</span>
<span class="comments">;   IDL End User License Agreement. The text of that license</span>
<span class="comments">;   can be found in the file LICENSE.RSI, included with this</span>
<span class="comments">;   software library.</span>
<span class="comments">; ==================================================================</span>
<span class="comments">;</span>
<span class="comments">;</span>
<span class="comments">; INPUTS:</span>
<span class="comments">;</span>
<span class="comments">;   UNIT - a logical unit number (a scalar).  In the case of GET_LUN,</span>
<span class="comments">;          a file unit will be allocated and returned in UNIT.  In the</span>
<span class="comments">;          default case, or REOPEN, UNIT must be a valid file unit</span>
<span class="comments">;          upon input.  For REOPEN the corresponding file must be</span>
<span class="comments">;          seekable.</span>
<span class="comments">;</span>
<span class="comments">;   FILENAME - a scalar string specifying the filename path (ignored</span>
<span class="comments">;              for REOPEN).</span>
<span class="comments">;</span>
<span class="comments">;   OFFSET - upon return, the file offset of the next available SAVE</span>
<span class="comments">;            record.</span>
<span class="comments">;</span>
<span class="comments">;</span>
<span class="comments">; KEYWORDS:</span>
<span class="comments">;</span>
<span class="comments">;   ACCESS - a scalar string, case insensitive:</span>
<span class="comments">;               'R' - read-only access</span>
<span class="comments">;               'W' - write access (new file)</span>
<span class="comments">;               'RW' - read-write access (existing file)</span>
<span class="comments">;            Default: 'R' - read-only</span>
<span class="comments">;</span>
<span class="comments">;   GET_LUN - if set, the file unit is allocated using GET_LUN</span>
<span class="comments">;</span>
<span class="comments">;   FORCE - if set, then the file is opened despite a detected file</span>
<span class="comments">;           format inconsistency.</span>
<span class="comments">;</span>
<span class="comments">;   REOPEN - if set, then an already-opened file is manipulated.  The</span>
<span class="comments">;            valid file unit must be specified by UNIT, and FILENAME</span>
<span class="comments">;            is ignored.</span>
<span class="comments">;</span>
<span class="comments">;   COMPATIBILITY - a string, which describes the format to be used in</span>
<span class="comments">;          the output file.  Possible values are:</span>
<span class="comments">;</span>
<span class="comments">;                  'IDL4' - format of IDL version 4;</span>
<span class="comments">;                  'IDL5' - format of IDL versions 5.0-5.3;</span>
<span class="comments">;                  'IDL6' - not supported yet, for versions 5.4-above;</span>
<span class="comments">;                  'RIVAL1' - same as 'IDL5', plus a directory entry is</span>
<span class="comments">;                            written to the file.</span>
<span class="comments">;           Note that files written in IDL5 format may still be</span>
<span class="comments">;           readable by IDL v.4.</span>
<span class="comments">;           Default: 'IDL5'</span>
<span class="comments">;</span>
<span class="comments">;</span>
<span class="comments">;   STATUS - upon return, this keyword will contain 1 for success and</span>
<span class="comments">;            0 for failure.</span>
<span class="comments">;</span>
<span class="comments">;   ERRMSG - upon return with a failure, this keyword will contain the</span>
<span class="comments">;            error condition as a string.</span>
<span class="comments">;</span>
<span class="comments">; EXAMPLE:</span>
<span class="comments">;</span>
<span class="comments">;</span>
<span class="comments">; SEE ALSO:</span>
<span class="comments">;</span>
<span class="comments">;   CMRESTORE, SAVE, RESTORE, CMSVLIB</span>
<span class="comments">;</span>
<span class="comments">; MODIFICATION HISTORY:</span>
<span class="comments">;   Written, 2000</span>
<span class="comments">;   Documented, 24 Jan 2001</span>
<span class="comments">;   Change BLOCK to STREAM to support VMS properly, 14 Feb 2001, CM</span>
<span class="comments">;   Added notification about RSI License, 13 May 2002, CM</span>
<span class="comments">;   NOTE: remember to modify CMSVLIB.PRO when changing library!</span>
<span class="comments">;</span>
<span class="comments">; $Id: cmsv_open.pro,v 1.13 2009/11/22 22:50:49 craigm Exp $</span>
<span class="comments">;</span>
<span class="comments">;-</span>
<span class="comments">; Copyright (C) 2000-2001, Craig Markwardt</span>
<span class="comments">; This software is provided as is without any warranty whatsoever.</span>
<span class="comments">; Permission to use, copy, modify, and distribute modified or</span>
<span class="comments">; unmodified copies is granted, provided this copyright and disclaimer</span>
<span class="comments">; are included unchanged.</span>
<span class="comments">;-</span>
<a id="cmsv_open:source"></a>pro cmsv_open, unit, filename, offset, access=access0, force=force, $
               get_lun=get_lun, status=status, errmsg=errmsg, $
               reopen=reopen, compatibility=compat, query=query, $
               compressed=compressed

  status = 0
  offset = 0L
  errmsg = ''
  error = 0

  if keyword_set(query) then return

  if keyword_set(get_lun) then get_lun, unit
  if n_elements(access0) EQ 0 then access0 = 'R'
  access = strupcase(strtrim(access0(0),2))

  if access NE 'R' AND access NE 'W' AND access NE 'RW' then begin
      errmsg = 'ERROR: CMSV_OPEN: ACCESS must be one of "R", "RW" or "W"'
      status = 0
      return
  endif

  <span class="comments">;; RE-OPEN</span>

  if keyword_set(reopen) then begin
      <span class="comments">;; Re-open an existing unit, but first make sure it's open</span>
      unit = floor(unit(0))
      stat = fstat(unit)
      errmsg = 'ERROR: CMSV_OPEN: Unit '+strtrim(unit,2)+' is not open'
      if stat.open EQ 0 then begin
          REOPEN_ERROR:
          return
      endif
      if access EQ 'R' then begin
          if stat.read EQ 0 then begin
              errmsg = errmsg + ' for reading'
              goto, REOPEN_ERROR
          endif
      endif else if access EQ 'RW' then begin
          if stat.read EQ 0 OR stat.write EQ 0 then begin
              errmsg = errmsg + ' for reading and writing'
              goto, REOPEN_ERROR
          endif
      endif else begin
          if stat.read EQ 0 OR stat.write EQ 0 then begin
              errmsg = errmsg + ' for writing'
              goto, REOPEN_ERROR
          endif
      endelse

      point_lun, unit, 0L
      errmsg = ''
  endif

  <span class="comments">;; READ or READ-WRITE ACCESS</span>

  if access EQ 'R' OR access EQ 'RW' then begin
      compressed = 0L

      if NOT keyword_set(reopen) then begin
          if access EQ 'R' then cmd = 'openr' else cmd = 'openu'
          call_procedure, cmd, unit(0), filename, error=error, /STREAM
          
          if error NE 0 then begin
              READ_ERROR:
              close, unit(0)
              if keyword_set(get_lun) then free_lun, unit(0)
              status = 0
              errmsg = !err_string
              return
          endif
      endif

      <span class="comments">;; Read 4-byte signature at start of file</span>
      on_ioerror, READ_ERROR
      signature = bytarr(4)
      readu, unit, signature
      if string(signature(0:1)) NE 'SR' then begin
          close, unit(0)
          if keyword_set(get_lun) then free_lun, unit(0)
          errmsg = 'ERROR: CMSV_OPEN: '+strtrim(filename(0),2)+ $
            ' is not a valid SAVE file'
          return
      endif

      <span class="comments">;; Check for compressed files, which are not supported</span>
      if signature(3) EQ 6 then begin
          compressed = 1
          if NOT keyword_set(force) then begin
              errmsg = 'ERROR: CMSVLIB library cannot read '+ $
                'compressed files'
              status = 0
              return
          endif
      endif
  endif else if access EQ 'W' then begin

      <span class="comments">;; WRITE-ONLY (CREATE) ACCESS</span>
      
      if NOT keyword_set(reopen) then begin
          openw, unit, filename, error=error, /STREAM

          if error NE 0 then begin
              WRITE_ERROR:
              close, unit(0)
              if keyword_set(get_lun) then free_lun, unit(0)
              status = 0
              errmsg = !err_string
              return
          endif
      endif

      <span class="comments">;; Write a valid signature</span>
      vbyte = '04'xb
      <span class="comments">;; '06'xb would indicate a compressed SAVE file, which we don't</span>
      <span class="comments">;; support.</span>

      on_ioerror, WRITE_ERROR
      <span class="comments">;              S       R</span>
      signature = ['53'xb, '52'xb, '00'xb, vbyte]
      writeu, unit, signature
  endif

  status = 1
  point_lun, -unit, offset
  return
end
</code>
    </div>
  </body>
</html>