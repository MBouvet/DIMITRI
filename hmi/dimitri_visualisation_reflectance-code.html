<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Tue Jul  2 12:50:53 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>dimitri_visualisation_reflectance.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="dimitri_visualisation_reflectance.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;*</span>
<span class="comments">;* NAME:</span>
<span class="comments">;*      DIMITRI_VISUALISATION_REFLECTANCE     </span>
<span class="comments">;* </span>
<span class="comments">;* PURPOSE:</span>
<span class="comments">;*      THIS PROGRAM AUTOMATICALLY SERACHES AND RETRIEVES THE DOUBLET REFLECTANCE </span>
<span class="comments">;*      INFORMATION OUTPUT BY DIMITRI GIVEN AN OUTPUT FOLDER AND REFERENCE </span>
<span class="comments">;*      SENSOR CONFIGURATION.</span>
<span class="comments">;* </span>
<span class="comments">;* CALLING SEQUENCE:</span>
<span class="comments">;*      RES = DIMITRI_VISUALISATION_REFLECTANCE(ED_FOLDER,VR_REGION,DIMITRI_BAND,REF_SENSOR,$</span>
<span class="comments">;*                                              REF_PROC_VER,VERBOSE=VERBOSE)    </span>
<span class="comments">;*</span>
<span class="comments">;* INPUTS:</span>
<span class="comments">;*      ED_FOLDER     - A STRING OF THE FULL PATH FOR THE DOUBLET_EXTRACTION OUTPUT FOLDER</span>
<span class="comments">;*      VR_REGION     - A STRING OF THE DIMITRI VALIDATION SITE REQUESTED</span>
<span class="comments">;*      DIMITRI_BAND  - THE REQUIRED DIMITRI BAND INDEX (STARTS FROM 0)</span>
<span class="comments">;*      REF_SENSOR    - A STRING OF THE REFERENCE SENSOR UTILISED FOR PROCESSING</span>
<span class="comments">;*      REF_PROC_VER  - A STRING OF THE REFERENCE SENSOR'S PROCESSING VERSION </span>
<span class="comments">;*</span>
<span class="comments">;* KEYWORDS:</span>
<span class="comments">;*      VERBOSE - PROCESSING STATUS OUTPUTS</span>
<span class="comments">;*</span>
<span class="comments">;* OUTPUTS:</span>
<span class="comments">;*      A STRUCTURE WITH THE FOLLOWING TAGS:</span>
<span class="comments">;*      ERROR                 - THE ERROR STATUS CODE, 0 = NOMINAL, 1 OR -1 = ERROR</span>
<span class="comments">;*      DATA                  - AN ARRAY CONTAINING ALL DOUBLET REFLECTANCE</span>
<span class="comments">;*      NUM_SENS_CONFIGS      - NUMBER OF SENSOR CONFIGURATIONS FOUND</span>
<span class="comments">;*      SENSOR_CONFIGS        - A STRING OF THE SENSOR CONFIGURATIONS FOUND</span>
<span class="comments">;*      NUM_XELEMENTS         - TOTAL NUMBER OF X VALUES (DATES) RETIREVED</span>
<span class="comments">;*      SENS_CONFIG_ABLE      - AN INTEGER ARRAY DESCRIBING IF DATA IS AVAILABLE FOR A</span>
<span class="comments">;*                              CERTAIN SENSOR CONFIGURATION</span>
<span class="comments">;*      SENS_CONFIG_ABLE_CHI  - AN INTEGER ARRAY DESCRIBING IF CHI DATA IS AVAILABLE FOR A</span>
<span class="comments">;*                              CERTAIN SENSOR CONFIGURATION</span>
<span class="comments">;*</span>
<span class="comments">;* COMMON BLOCKS:</span>
<span class="comments">;*      NONE</span>
<span class="comments">;*</span>
<span class="comments">;* MODIFICATION HISTORY:</span>
<span class="comments">;*      08 FEB 2011 - C KENT    - DIMITRI-2 V1.0</span>
<span class="comments">;*      08 MAR 2011 - C KENT    - ADDED DIALOG MESSAGE AND EXIT IF NO REFERENCE DATA FOUND</span>
<span class="comments">;*      04 JUL 2011 - C KENT    - ADDED AUX INFO TO INTERNAL SAV FILE</span>
<span class="comments">;*      25 JUL 2011 - C KENT    - MINOR BUG FIX DURING AMC DATA RETRIEVAL</span>
<span class="comments">;*</span>
<span class="comments">;* VALIDATION HISTORY:</span>
<span class="comments">;*      08 FEB 2011 - C KENT    - WINDOWS 32-BIT MACHINE IDL 7.1/IDL 8.0: NOMINAL </span>
<span class="comments">;*      14 APR 2011 - C KENT    - WINDOWS 32-BIT IDL 7.1 AND LINUX 64-BIT IDL 8.0 NOMINAL</span>
<span class="comments">;*                                COMPILATION AND OPERATION</span>
<span class="comments">;*</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

FUNCTION DIMITRI_VISUALISATION_REFLECTANCE,ED_FOLDER,VR_REGION,DIMITRI_BAND,REF_SENSOR,$
                                           REF_PROC_VER,VERBOSE=VERBOSE

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DIMITRI_VISU_REFL: STARTING RETRIEVAL OF DIMITRI REFLECTANCE DATA'

<span class="comments">;--------------------------------</span>
<span class="comments">; FIND ALL CORRESPONDING DOUBLET </span>
<span class="comments">; EXTRACTION FILES </span>
  
  REF_STR = 'ED_'+VR_REGION+'_'+REF_SENSOR+'_'+REF_PROC_VER+'*.dat'
  CAL_STR = 'ED_'+VR_REGION+'_*'+REF_SENSOR+'_'+REF_PROC_VER+'.dat'

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DIMITRI_VISU_REFL: SEARCHING FOR DOUBLET DATA'
  REF_FILES = FILE_SEARCH(ED_FOLDER,REF_STR)
  CAL_FILES = FILE_SEARCH(ED_FOLDER,CAL_STR)
  
  IF STRCMP(REF_FILES[0],'') EQ 1 OR $
     STRCMP(CAL_FILES[0],'') EQ 1 OR $
     (N_ELEMENTS(REF_FILES) NE N_ELEMENTS(CAL_FILES)) THEN BEGIN
    PRINT, 'DIMITRI_VISU_REFL: ERROR, NO DOUBLET DATA FOUND'
    RETURN,{ERROR:1}
  ENDIF

<span class="comments">;-----------------------------------------</span>
<span class="comments">; RETRIEVE THE SITE TYPE</span>

  SITE_TYPE = GET_SITE_TYPE(VR_REGION) 

<span class="comments">;--------------------------------</span>
<span class="comments">; GET THE NUMBER OF REFERENCE/CALIBRATION </span>
<span class="comments">; FILES AVAILABLE     </span>
  
  NUM_REF_CONFIGS   = N_ELEMENTS(REF_FILES)
  NUM_CAL_CONFIGS   = N_ELEMENTS(CAL_FILES)
  NUM_SENS_CONFIGS  = 1+NUM_CAL_CONFIGS

<span class="comments">;--------------------------------</span>
<span class="comments">; START LIST OF ALL SENSOR AND </span>
<span class="comments">; PROCESSING VERSION CONFIGURATIONS, </span>
<span class="comments">; AND REFERENCE SENSOR DATES AND </span>
<span class="comments">; REFLECTANCE</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DIMITRI_VISU_REFL: DEFINING SENSOR CONFIGURAITON ARRAY'
  SENSOR_CONFIGS  = STRING(REF_SENSOR+'_'+REF_PROC_VER)
  SENS_CONFIG_ABLE= MAKE_ARRAY(NUM_SENS_CONFIGS,/INTEGER,VALUE=0)
  TMP_REF_DATE    = DOUBLE(0.0)
  TMP_REF_REFL    = DOUBLE(0.0)

<span class="comments">;-----------------------------------------</span>
<span class="comments">; MODISA SURFACE DEPENDANCE EXCEPTION</span>

  IF REF_SENSOR EQ 'MODISA' THEN BEGIN
    IF STRUPCASE(SITE_TYPE) EQ 'OCEAN' THEN TEMP_SENSOR = REF_SENSOR+'_O' ELSE TEMP_SENSOR = REF_SENSOR+'_L'
  ENDIF ELSE TEMP_SENSOR = REF_SENSOR 
 
<span class="comments">;--------------------------------  </span>
<span class="comments">; GET RELATED SENSOR INDEX BASED </span>
<span class="comments">; ON DIMITRI BAND ID</span>
  
  SENSOR_INDEX = GET_SENSOR_BAND_INDEX(TEMP_SENSOR,DIMITRI_BAND,VERBOSE=VERBOSE)

  IF SENSOR_INDEX LT 0 THEN BEGIN
    PRINT,'DIMITRI_VISU_REFL: ERROR, NO REFERENCE SENSOR VALUE FOR DIMITRI BAND'
    RETURN,{ERROR:1}
  ENDIF

<span class="comments">;-------------------------------- </span>
<span class="comments">; CONCATENATE DATE AND REFLECTANCE </span>
<span class="comments">; INFO FOR REFERENCE SENSOR</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DIMITRI_VISU_REFL: CONCATENATING REFERENCE SENSOR INFORMATION'  
  NUM_NON_REFS = 5+12 <span class="comments">;(TIME, ANGLES (4) AND AUX INFO (12)</span>
  FOR I=0,NUM_REF_CONFIGS-1 DO BEGIN
    RESTORE,REF_FILES[I]
    
    IF N_ELEMENTS(ED_SENSOR1_SENSOR2) EQ 0 THEN BEGIN
      MSG = ['DIMITRI_VISU_REFL ERROR:','','NO REFERENCE DATA FOR REQUESTED SENSOR CONFIGURATION','CLOSING...']
      RES = DIALOG_MESSAGE(MSG,TITLE = 'DIMITRI INTERNAL ERROR',/ERROR)
      RETURN,{ERROR:2}    
    ENDIF
     
    TEMP_ELEMENTS = N_ELEMENTS(ED_SENSOR1_SENSOR2[0,*])
    TMP_REF_DATE  = [TMP_REF_DATE,REFORM(ED_SENSOR1_SENSOR2[0,*],TEMP_ELEMENTS)]
    TMP_REF_REFL  = [TMP_REF_REFL,REFORM(DOUBLE(ED_SENSOR1_SENSOR2[NUM_NON_REFS+SENSOR_INDEX,*]),TEMP_ELEMENTS)]
  ENDFOR

<span class="comments">;--------------------------------</span>
<span class="comments">; SORT VALUES INTO ASCENDING TIME </span>
    
  TEMP          = SORT(TMP_REF_DATE)
  TMP_REF_DATE  = TMP_REF_DATE[TEMP[1:N_ELEMENTS(TEMP)-1]]
  TMP_REF_REFL  = TMP_REF_REFL[TEMP[1:N_ELEMENTS(TEMP)-1]]
  NUM_REF_DATE  = N_ELEMENTS(TMP_REF_DATE)

<span class="comments">;--------------------------------  </span>
<span class="comments">; CREATE AN ARRAY TO HOLD ALL TIME </span>
<span class="comments">; AND REFLECTANCE DATA FOR EACH </span>
<span class="comments">; SENSOR CONFIGURATION FOUND</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DIMITRI_VISU_REFL: DEFINING ARRAY TO HOLD ALL REFLECTANCE DATA'
  REFL_DATA         = MAKE_ARRAY(NUM_REF_DATE,NUM_SENS_CONFIGS,3,/DOUBLE)
  REFL_DATA[*,0,0]  = TMP_REF_DATE
  REFL_DATA[*,0,1]  = TMP_REF_REFL   
 
<span class="comments">;-------------------------------- </span>
<span class="comments">; RESTORE CAL FILES AND STORE </span>
<span class="comments">; THE DATA  </span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DIMITRI_VISU_REFL: STARTING LOOP ON ALL CAL-SENSOR FILES'
  SENS_CONFIG_ABLE[0] = 1
  FOR I=0,NUM_CAL_CONFIGS-1 DO BEGIN

<span class="comments">;-------------------------------- </span>
<span class="comments">; GET SENSOR CONFIGURATION FROM FILENAME</span>

    POS   = STRPOS(CAL_FILES[I],VR_REGION,/REVERSE_SEARCH)+STRLEN(VR_REGION)+1
    POS1  = STRPOS(CAL_FILES[I],REF_SENSOR,/REVERSE_SEARCH)-1
    TMP   = STRMID(CAL_FILES[I],POS,POS1-POS)
    SENSOR_CONFIGS = [SENSOR_CONFIGS,TMP]
    RESTORE,CAL_FILES[I]

<span class="comments">;--------------------------------</span>
<span class="comments">; GET SENSOR BAND INDEX</span>

    SENS_NAME = STRSPLIT(TMP,'_',/EXTRACT)
    SENS_NAME = SENS_NAME[0]
    
<span class="comments">;-----------------------------------------</span>
<span class="comments">; MODISA SURFACE DEPENDANCE EXCEPTION</span>

    IF SENS_NAME EQ 'MODISA' THEN BEGIN
      IF STRUPCASE(SITE_TYPE) EQ 'OCEAN' THEN TEMP_SENSOR = SENS_NAME+'_O' ELSE TEMP_SENSOR = SENS_NAME+'_L'
    ENDIF ELSE TEMP_SENSOR = SENS_NAME     
    
    IDX = GET_SENSOR_BAND_INDEX(TEMP_SENSOR,DIMITRI_BAND)
    IF IDX LT 0 THEN GOTO,NEXT_FILE
    SENS_CONFIG_ABLE[1+I] = 1

<span class="comments">;--------------------------------</span>
<span class="comments">; STORE TIME AND REFLECTANCE DATA</span>

    TEMP_ELEMENTS = N_ELEMENTS(ED_SENSOR2_SENSOR1[0,*])
    NB_COLS = N_ELEMENTS(ED_SENSOR2_SENSOR1[*,0])
    TMP_DATE = DOUBLE(ED_SENSOR2_SENSOR1[0,*])
    TMP_REFL = DOUBLE(ED_SENSOR2_SENSOR1[NUM_NON_REFS+IDX,*])
    TMP_CHIV = DOUBLE(ED_SENSOR2_SENSOR1[NB_COLS-1,*])
    SORT_IDX = SORT(TMP_DATE)    

    REFL_DATA[0:TEMP_ELEMENTS-1,I+1,0] = TMP_DATE[SORT_IDX]
    REFL_DATA[0:TEMP_ELEMENTS-1,I+1,1] = TMP_REFL[SORT_IDX]
    REFL_DATA[0:TEMP_ELEMENTS-1,I+1,2] = TMP_CHIV[SORT_IDX]
    NEXT_FILE:

  ENDFOR

<span class="comments">;--------------------------------</span>
<span class="comments">; CREATE ANOTHER SENSOR_ABLE ARRAY </span>
<span class="comments">; BUT SET THE REFERNCE SENSOR AS 0</span>

  SENS_CONFIG_ABLE_CHI = SENS_CONFIG_ABLE
  SENS_CONFIG_ABLE_CHI[0] = 0

<span class="comments">;--------------------------------</span>
<span class="comments">; RETURN ALL DATA IN A STRUCTURE</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DIMITRI_VISU_REFL: RETURNING REFLECTANCE DATA STRUCTURE'
  VISU_REFL = {                                             $
              ERROR:0                                       ,$
              DATA:REFL_DATA                                ,$
              NUM_SENS_CONFIGS:NUM_SENS_CONFIGS             ,$
              SENSOR_CONFIGS:SENSOR_CONFIGS                 ,$
              NUM_XELEMENTS:NUM_REF_DATE                    ,$
              SENS_CONFIG_ABLE_AMC:SENS_CONFIG_ABLE_CHI     ,$
              SENS_CONFIG_ABLE:SENS_CONFIG_ABLE             $
              }

  RETURN,VISU_REFL

END
</code>
    </div>
  </body>
</html>