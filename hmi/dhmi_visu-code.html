<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Tue Jul  2 12:50:51 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>dhmi_visu.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="dhmi_visu.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;*</span>
<span class="comments">;* NAME:</span>
<span class="comments">;*      DHMI_VISU    </span>
<span class="comments">;* </span>
<span class="comments">;* PURPOSE:</span>
<span class="comments">;*      THIS PROGRAM DISPLAYS A WIDGET ALLOWING SPECIFICATION OF THE REQUIRED PARAMETERS </span>
<span class="comments">;*      TO START THE VISUALISATION OBJET GRAPHICS INTERFACE. USER'S ARE REQUESTED TO </span>
<span class="comments">;*      PROVIDE THE OUTPUTFOLDER, SITE, REFERENCE SENSOR, REFERENCE PROCESSING VERSION</span>
<span class="comments">;*      AND DIMITRI BAND. </span>
<span class="comments">;*</span>
<span class="comments">;* CALLING SEQUENCE:</span>
<span class="comments">;*      DHMI_VISU      </span>
<span class="comments">;*</span>
<span class="comments">;* INPUTS:</span>
<span class="comments">;*      NONE</span>
<span class="comments">;*</span>
<span class="comments">;* KEYWORDS:</span>
<span class="comments">;*      GROUP_LEADER - THE ID OF ANOTHER WIDGET TO BE USED AS THE GROUP LEADER</span>
<span class="comments">;*      VERBOSE      - PROCESSING STATUS OUTPUTS</span>
<span class="comments">;*</span>
<span class="comments">;* OUTPUTS:</span>
<span class="comments">;*      NONE</span>
<span class="comments">;*</span>
<span class="comments">;* COMMON BLOCKS:</span>
<span class="comments">;*      DHMI_DATABASE - CONTAINS THE DATABASE DATA FOR THE DIMITRI HMI</span>
<span class="comments">;*</span>
<span class="comments">;* MODIFICATION HISTORY:</span>
<span class="comments">;*      08 MAR 2011 - C KENT    - DIMITRI-2 V1.0</span>
<span class="comments">;*      21 MAR 2011 - C KENT    - MODIFIED FILE DEFINITION TO USE GET_DIMITRI_LOCATION</span>
<span class="comments">;*      06 JUL 2011 - C KENT    - ADDED DATABASE COMMON BLOCK TO DIMITRI HMI</span>
<span class="comments">;*</span>
<span class="comments">;* VALIDATION HISTORY:</span>
<span class="comments">;*      14 APR 2011 - C KENT    - WINDOWS 32-BIT IDL 7.1 AND LINUX 64-BIT IDL 8.0 NOMINAL</span>
<span class="comments">;*                                COMPILATION AND OPERATION       </span>
<span class="comments">;*</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

PRO DHMI_VISU_DROPLIST,EVENT

<span class="comments">;--------------------------</span>
<span class="comments">; CATCH THE DROPLIST EVENT </span>
<span class="comments">; AND DO NOTHING</span>
  
  WIDGET_CONTROL, EVENT.TOP, GET_UVALUE=DHMI_VISU_INFO, /NO_COPY
  WIDGET_CONTROL, EVENT.TOP, SET_UVALUE=DHMI_VISU_INFO, /NO_COPY

END

<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

PRO DHMI_VISU_EXIT,EVENT

<span class="comments">;--------------------------</span>
<span class="comments">; GET EVENT AND WIDGET INFO</span>

  WIDGET_CONTROL, EVENT.TOP,  GET_UVALUE=DHMI_VISU_INFO, /NO_COPY
  IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN $
    PRINT,'DHMI_VISU: FINDING AVAILABLE SENSORS WITHIN SITE AND OUTPUTFOLDER'

<span class="comments">;--------------------------</span>
<span class="comments">; CLEAN UP OBJECTS</span>

  IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN PRINT,'DHMI_VISU->EXIT: DESTROYING ALL OBJECTS'
  OBJ_DESTROY,DHMI_VISU_INFO.FSCOUTF
  OBJ_DESTROY,DHMI_VISU_INFO.FSCSITE
  OBJ_DESTROY,DHMI_VISU_INFO.FSCSENS
  OBJ_DESTROY,DHMI_VISU_INFO.FSCPROC

<span class="comments">;--------------------------</span>
<span class="comments">; DESTROY THE WIDGET</span>

  IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN PRINT,'DHMI_VISU->EXIT: DESTROYING THE WIDGET'
  WIDGET_CONTROL,EVENT.TOP,/DESTROY

END

<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

PRO DHMI_VISU_START,EVENT

  WIDGET_CONTROL, EVENT.TOP,  GET_UVALUE=DHMI_VISU_INFO, /NO_COPY

<span class="comments">;--------------------------</span>
<span class="comments">; GET REQUIRED VALUES FROM WIDGET</span>

  IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN PRINT,'DHMI_VISU->START: RETRIEVING REQUIRED VALUES FROM WIDGET'
  DHMI_VISU_INFO.FSCOUTF->GETPROPERTY,VALUE=VISU_OUTPUT_FOLDER
  DHMI_VISU_INFO.FSCSITE->GETPROPERTY,VALUE=VISU_SITE
  DHMI_VISU_INFO.FSCSENS->GETPROPERTY,VALUE=VISU_SENSOR
  DHMI_VISU_INFO.FSCPROC->GETPROPERTY,VALUE=VISU_PROCV

  IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN PRINT,'DHMI_VISU->START: SETTING OUTPUT FOLDER AND DROPLIST VALUES'
  VISU_OUTPUT_FOLDER  = DHMI_VISU_INFO.VISU_OFOLDER+DHMI_VISU_INFO.DL+VISU_OUTPUT_FOLDER
  TEMP                = WIDGET_INFO(DHMI_VISU_INFO.DROPID, /DROPLIST_SELECT)
  WIDGET_CONTROL, DHMI_VISU_INFO.DROPID, GET_UVALUE=DROPLIST
  VISU_BAND           = DROPLIST[TEMP]
  
  RES       = STRPOS(VISU_BAND,' nm')
  VISU_BAND = STRMID(VISU_BAND,3,STRLEN(VISU_BAND)-6)
  VISU_BAND = CONVERT_WAVELENGTH_TO_DINDEX(VISU_BAND)+1

<span class="comments">;--------------------------</span>
<span class="comments">; GET SCREEN DIMENSIONS FOR </span>
<span class="comments">; CENTERING WIDGET</span>

  DIMS  = GET_SCREEN_SIZE()
  XSIZE = 200
  YSIZE = 60
  XLOC  = (DIMS[0]/2)-(XSIZE/2)
  YLOC  = (DIMS[1]/2)-(YSIZE/2)
  
<span class="comments">;--------------------------</span>
<span class="comments">; CREATE A POP WIDGET AND START </span>
<span class="comments">; THE VISUALISATION INTERFACE</span>

  IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN PRINT,'DHMI_VISU->START: CREATING A POP WIDGET '
  INFO_WD = WIDGET_BASE(COLUMN=1, XSIZE=XSIZE, YSIZE=YSIZE, TITLE='Please Wait...',XOFFSET=XLOC,YOFFSET=YLOC)
  LBLTXT  = WIDGET_LABEL(INFO_WD,VALUE=' ')
  LBLTXT  = WIDGET_LABEL(INFO_WD,VALUE='Please wait,')
  LBLTXT  = WIDGET_LABEL(INFO_WD,VALUE='Loading in progress...')
  WIDGET_CONTROL, INFO_WD, /REALIZE
  WIDGET_CONTROL, /HOURGLASS
  IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN BEGIN
    PRINT,'DHMI_VISU->START: CALLING THE VISUALISATION ROUTINE'  
    DIMITRI_VISUALISATION,VISU_OUTPUT_FOLDER,VISU_SITE,VISU_BAND,$
                          VISU_SENSOR,VISU_PROCV,GROUP_LEADER=EVENT.TOP,/VERBOSE
  ENDIF ELSE DIMITRI_VISUALISATION,VISU_OUTPUT_FOLDER,VISU_SITE,VISU_BAND,$
                                   VISU_SENSOR,VISU_PROCV,GROUP_LEADER=EVENT.TOP

  IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN PRINT,'DHMI_VISU->START: DESTROYING THE POP WIDGET'    
  WIDGET_CONTROL,INFO_WD,/DESTROY
  WIDGET_CONTROL, EVENT.TOP, SET_UVALUE=DHMI_VISU_INFO, /NO_COPY

END

<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

PRO DHMI_VISU_CHANGE,EVENT

  WIDGET_CONTROL, EVENT.TOP,  GET_UVALUE=DHMI_VISU_INFO, /NO_COPY
  WIDGET_CONTROL, EVENT.ID,   GET_UVALUE=ACTION

<span class="comments">;--------------------------</span>
<span class="comments">; GET THE ACTION TYPE</span>

  ACTION_TYPE = STRMID(ACTION,0,1)

<span class="comments">;--------------------------</span>
<span class="comments">; DEPENDING ON ACTION TYPE </span>
<span class="comments">; PERFORM DIFFERENT SECTIONS </span>
<span class="comments">; OF THE PROGRAM</span>

<span class="comments">;--------------------------</span>
<span class="comments">; MODIFY THE OUTPUT FOLDER </span>
<span class="comments">; AND SUBSEQUENT FIELDS</span>

  IF ACTION_TYPE EQ 'O' THEN BEGIN
  IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN PRINT,'DHMI_VISU->CHANGE: CHANGING OUTPUT FOLDER'
    IF DHMI_VISU_INFO.NOUTFS EQ 1 THEN GOTO, NO_CHANGE_OUTF
    CASE ACTION OF
      'OUTF&lt;':DHMI_VISU_INFO.IOUTF = DHMI_VISU_INFO.IOUTF-1
      'OUTF>':DHMI_VISU_INFO.IOUTF = DHMI_VISU_INFO.IOUTF+1
    ENDCASE
    IF DHMI_VISU_INFO.IOUTF LT 0 THEN DHMI_VISU_INFO.IOUTF = DHMI_VISU_INFO.NOUTFS-1
    IF DHMI_VISU_INFO.IOUTF EQ DHMI_VISU_INFO.NOUTFS THEN DHMI_VISU_INFO.IOUTF = 0     
    DHMI_VISU_INFO.FSCOUTF->SETPROPERTY, VALUE=DHMI_VISU_INFO.AOUTF[DHMI_VISU_INFO.IOUTF] 
    TMP_IOUTF = DHMI_VISU_INFO.IOUTF 
    GOTO, NO_CHANGE_OUTF

<span class="comments">;--------------------------</span>
<span class="comments">; UPDATE LIST OF AVAILABLE SITES</span>

   IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN PRINT,'DHMI_VISU->CHANGE: CHANGING AVAILABLE SITES'
    NASITE=0
    FOR I=0,DHMI_VISU_INFO.NSITES-1 DO BEGIN 
      RES = TOTAL(DHMI_VISU_INFO.DATA_AVBLE[*,*,I,DHMI_VISU_INFO.IOUTF])
      IF RES GT 0 THEN BEGIN
        DHMI_VISU_INFO.ASITES[NASITE]=DHMI_VISU_INFO.USITES[I]
        NASITE++
      ENDIF
    ENDFOR

    DHMI_VISU_INFO.ISITE = 0
    DHMI_VISU_INFO.NASITE = NASITE
    DHMI_VISU_INFO.FSCSITE->SETPROPERTY, VALUE=DHMI_VISU_INFO.ASITES[0]

<span class="comments">;--------------------------</span>
<span class="comments">; UPDATE SENSORS AND PROC_VERS </span>
        
    GOTO, UPDATE_SENS_VALUES
    NO_CHANGE_OUTF:
  ENDIF

<span class="comments">;--------------------------</span>
<span class="comments">; MODIFY THE REGION </span>
<span class="comments">; AND SUBSEQUENT FIELDS</span>

  IF ACTION_TYPE EQ 'R' THEN BEGIN
  IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN PRINT,'DHMI_VISU->CHANGE: CHANGING REGION SELECTED'
    IF DHMI_VISU_INFO.NASITE EQ 1 THEN GOTO, NO_CHANGE_SITE
    CASE ACTION OF
      'RSITE&lt;':DHMI_VISU_INFO.ISITE = DHMI_VISU_INFO.ISITE-1
      'RSITE>':DHMI_VISU_INFO.ISITE = DHMI_VISU_INFO.ISITE+1
    ENDCASE
    IF DHMI_VISU_INFO.ISITE LT 0 THEN DHMI_VISU_INFO.ISITE = DHMI_VISU_INFO.NASITE-1
    IF DHMI_VISU_INFO.ISITE EQ DHMI_VISU_INFO.NASITE THEN DHMI_VISU_INFO.ISITE = 0
    DHMI_VISU_INFO.FSCSITE->SETPROPERTY, VALUE=DHMI_VISU_INFO.ASITES[DHMI_VISU_INFO.ISITE]
    GOTO, NO_CHANGE_SITE

<span class="comments">;--------------------------</span>
<span class="comments">; UPDATE LIST OF AVAILABLE SENSORS</span>

    UPDATE_SENS_VALUES:
    IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN PRINT,'DHMI_VISU->CHANGE: CHANGING AVAILABLE SENSORS'
    TMP_ISITE = WHERE(DHMI_VISU_INFO.USITES EQ DHMI_VISU_INFO.ASITES[DHMI_VISU_INFO.ISITE])
    NASENS = 0
    FOR I=0,N_ELEMENTS(DHMI_VISU_INFO.USENSS)-1 DO BEGIN
      IF TOTAL(DHMI_VISU_INFO.DATA_AVBLE[*,I,TMP_ISITE,DHMI_VISU_INFO.IOUTF]) GE 1 THEN BEGIN
        DHMI_VISU_INFO.ASENSS[NASENS] = DHMI_VISU_INFO.USENSS[I]
        NASENS++ 
      ENDIF
    ENDFOR     
    DHMI_VISU_INFO.ISENS = 0
    DHMI_VISU_INFO.NASENS = NASENS     
    DHMI_VISU_INFO.FSCSENS->SETPROPERTY, VALUE=DHMI_VISU_INFO.ASENSS[0]

<span class="comments">;--------------------------</span>
<span class="comments">; UPDATE LIST OF AVAILABLE PROC VERSIONS</span>

    GOTO,UPDATE_PROC_VALUES 
    NO_CHANGE_SITE:
  ENDIF

<span class="comments">;--------------------------</span>
<span class="comments">; MODIFY THE SENSOR</span>
<span class="comments">; AND SUBSEQUENT FIELDS</span>

  IF ACTION_TYPE EQ 'S' THEN BEGIN
  IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN PRINT,'DHMI_VISU->CHANGE: CHANGING SENSOR SELECTED'
    <span class="comments">;IF DHMI_VISU_INFO.NASENS EQ 1 THEN GOTO, NO_CHANGE_SENS</span>
    CASE ACTION OF
      'SENSOR&lt;':DHMI_VISU_INFO.ISENS = DHMI_VISU_INFO.ISENS-1
      'SENSOR>':DHMI_VISU_INFO.ISENS = DHMI_VISU_INFO.ISENS+1
    ENDCASE
    IF DHMI_VISU_INFO.ISENS LT 0 THEN DHMI_VISU_INFO.ISENS = DHMI_VISU_INFO.NASENS-1
    IF DHMI_VISU_INFO.ISENS EQ DHMI_VISU_INFO.NASENS THEN DHMI_VISU_INFO.ISENS = 0

<span class="comments">;--------------------------</span>
<span class="comments">; UPDATE LIST OF AVAILABLE PROC VERSIONS</span>

    UPDATE_PROC_VALUES:
    IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN $
      PRINT,'DHMI_VISU->CHANGE: CHANGING AVAILABLE PROCESSING VERSIONS'
    TMP_ISENS = WHERE(DHMI_VISU_INFO.USENSS EQ DHMI_VISU_INFO.ASENSS[DHMI_VISU_INFO.ISENS])
    TMP_ISITE = WHERE(DHMI_VISU_INFO.USITES EQ DHMI_VISU_INFO.ASITES[DHMI_VISU_INFO.ISITE])
       
    RES = WHERE(DHMI_VISU_INFO.DATA_AVBLE[*,TMP_ISENS,TMP_ISITE,DHMI_VISU_INFO.IOUTF] EQ 1,COUNT)
    IF COUNT EQ 0 THEN DHMI_VISU_INFO.APROC[*] = 'N/A' ELSE $
    DHMI_VISU_INFO.APROC[0:COUNT-1] = DHMI_VISU_INFO.UPROCV[RES]
    DHMI_VISU_INFO.NAPROC=COUNT
    DHMI_VISU_INFO.IPROC = 0

<span class="comments">;--------------------------</span>
<span class="comments">; UPDATE LIST OF AVAILABLE DIMITRI BANDS</span>

    IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN $
      PRINT,'DHMI_VISU->CHANGE: UPDATING LIST OF AVAILABLE DIMITRI BANDS'       
    
<span class="comments">;-----------------------------------------</span>
<span class="comments">; RETRIEVE THE SITE TYPE</span>

    SITE_TYPE = GET_SITE_TYPE(DHMI_VISU_INFO.ASITES[DHMI_VISU_INFO.ISITE]) 

<span class="comments">;-----------------------------------------</span>
<span class="comments">; MODISA SURFACE DEPENDANCE EXCEPTION</span>

    IF DHMI_VISU_INFO.ASENSS[DHMI_VISU_INFO.ISENS] EQ 'MODISA' THEN BEGIN
      IF STRUPCASE(SITE_TYPE) EQ 'OCEAN' THEN TEMP_SENSOR = DHMI_VISU_INFO.ASENSS[DHMI_VISU_INFO.ISENS]+'_O' ELSE TEMP_SENSOR = DHMI_VISU_INFO.ASENSS[DHMI_VISU_INFO.ISENS]+'_L'
    ENDIF ELSE TEMP_SENSOR = DHMI_VISU_INFO.ASENSS[DHMI_VISU_INFO.ISENS]
   
    NB_BANDS = SENSOR_BAND_INFO(DHMI_VISU_INFO.ASENSS[DHMI_VISU_INFO.ISENS])
    DB_IDX = STRARR(NB_BANDS)
    TT=0
    FOR I=0,NB_BANDS[0]-1 DO BEGIN
    
      TMP = CONVERT_INDEX_TO_WAVELENGTH(I,TEMP_SENSOR)
      IF TMP NE 'ERROR' THEN BEGIN
        DB_IDX[TT] = STRTRIM(STRING(TT+1),2)+': '+TMP+' nm' 
        TT++
      ENDIF
    ENDFOR
    DB_IDX=DB_IDX[0:TT-1]

<span class="comments">;--------------------------</span>
<span class="comments">; UPDATE WIDGET FOR USER</span>
        
    DHMI_VISU_INFO.FSCSENS->SETPROPERTY, VALUE=DHMI_VISU_INFO.ASENSS[DHMI_VISU_INFO.ISENS]
    DHMI_VISU_INFO.FSCPROC->SETPROPERTY, VALUE=DHMI_VISU_INFO.APROC[DHMI_VISU_INFO.IPROC]
    WIDGET_CONTROL, DHMI_VISU_INFO.DROPID, SET_VALUE=DB_IDX,SET_UVALUE=DB_IDX

    NO_CHANGE_SENS:
  ENDIF

<span class="comments">;--------------------------</span>
<span class="comments">; UPDATE PROCESSING VERSION</span>

  IF ACTION_TYPE EQ 'P' THEN BEGIN
  IF DHMI_VISU_INFO.IVERBOSE EQ 1 THEN PRINT,'DHMI_VISU->CHANGE: CHANGING THE PROCESSING VERSION VALUE'
    CASE ACTION OF
      'PROC&lt;':DHMI_VISU_INFO.IPROC = DHMI_VISU_INFO.IPROC-1
      'PROC>':DHMI_VISU_INFO.IPROC = DHMI_VISU_INFO.IPROC+1
    ENDCASE
    IF DHMI_VISU_INFO.IPROC LT 0 THEN DHMI_VISU_INFO.IPROC = DHMI_VISU_INFO.NAPROC-1
    IF DHMI_VISU_INFO.IPROC EQ DHMI_VISU_INFO.NAPROC THEN DHMI_VISU_INFO.IPROC = 0 
    DHMI_VISU_INFO.FSCPROC->SETPROPERTY, VALUE=DHMI_VISU_INFO.APROC[DHMI_VISU_INFO.IPROC]
  ENDIF

<span class="comments">;--------------------------</span>
<span class="comments">; RETRUN TO THE WIDGET</span>

  WIDGET_CONTROL, EVENT.TOP, SET_UVALUE=DHMI_VISU_INFO, /NO_COPY

END

<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

<a id="DHMI_VISU:source"></a>pro DHMI_VISU,GROUP_LEADER=GROUP_LEADER,VERBOSE=VERBOSE

WIDGET_CONTROL,/HOURGLASS
COMMON DHMI_DATABASE

<span class="comments">;--------------------------</span>
<span class="comments">; FIND MAIN DIMITRI FOLDER AND DELIMITER</span>

  IF KEYWORD_SET(VERBOSE) THEN BEGIN
    PRINT,'DHMI_VISU: STARTING HMI VISUALISATION ROUTINE'
    IVERBOSE=1
  ENDIF ELSE IVERBOSE=0

  IF STRUPCASE(!VERSION.OS_FAMILY) EQ 'WINDOWS' THEN WIN_FLAG = 1 ELSE WIN_FLAG = 0  
  CD, CURRENT=CDIR

  DL            = GET_DIMITRI_LOCATION('DL')
  VISU_OFOLDER  = GET_DIMITRI_LOCATION('OUTPUT')
  
<span class="comments">;--------------------------</span>
<span class="comments">; GET LIST OF ALL OUTPUT FOLDERS</span>
  
  CD,VISU_OFOLDER
  SITE_SEARCH = FILE_SEARCH(/TEST_DIRECTORY)
  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DHMI_VISU: DIRECTORIES FOUND IN OUTPUT FOLDER = ',SITE_SEARCH
  CD,CDIR
  
  IF SITE_SEARCH[0] EQ '' THEN BEGIN
    MSG='DHMI_VISU: ERROR, NO SITES FOUND IN INPUT FOLDER!'
    TMP = DIALOG_MESSAGE(MSG,/ERROR,/CENTER)
    RETURN
  ENDIF 

<span class="comments">;--------------------------</span>
<span class="comments">; GET LIST OF ALL OUTPUT FOLDERS, </span>
<span class="comments">; SITES, SENSORS AND PROCESSING VERSIONS</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DHMI_VISU: RETRIEVING UNIQ SITES, SENSORS AND PROC VERSIONS
	USITES = DHMI_DB_DATA.REGION[UNIQ(DHMI_DB_DATA.REGION,SORT(DHMI_DB_DATA.REGION))]
	USENSS = DHMI_DB_DATA.SENSOR[UNIQ(DHMI_DB_DATA.SENSOR,SORT(DHMI_DB_DATA.SENSOR))]
	UPROCV = DHMI_DB_DATA.PROCESSING_VERSION[UNIQ(DHMI_DB_DATA.PROCESSING_VERSION,$
	                                     SORT(DHMI_DB_DATA.PROCESSING_VERSION))]

	NOUTFS = N_ELEMENTS(SITE_SEARCH)
	NSITES = N_ELEMENTS(USITES)
	NSENSS = N_ELEMENTS(USENSS)
	NPROCV = N_ELEMENTS(UPROCV)

<span class="comments">;--------------------------</span>
<span class="comments">; CREATE AN ARRAY TO HOLD INFORMATION IF PROC_VERSION </span>
<span class="comments">; IS AVAILABLE FOR EACH SENSOR, SITE AND OUTPUTFOLDER</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DHMI_VISU: CREATING ARRAY OF AVAILABLE INDEXES'
	DATA_AVBLE = MAKE_ARRAY(NPROCV,NSENSS,NSITES,NOUTFS,/INTEGER,VALUE=1)

<span class="comments">;;--------------------------</span>
<span class="comments">;; GET A LIST OF ALL FILES</span>
<span class="comments">;</span>
<span class="comments">;  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DHMI_VISU: RETRIEVING LIST OF ALL FILES'</span>
<span class="comments">;  FILE_LIST = FILE_SEARCH(VISU_OFOLDER,'*',/FULLY_QUALIFY_PATH)</span>

<span class="comments">;--------------------------</span>
<span class="comments">; LOOP OVER EACH VARIABLE, SEARCH FOR FILES </span>
<span class="comments">; WITH CORRECT TITLES, IF MORE THAN ONE FOUND </span>
<span class="comments">; THEN INSERT A 1 IN DATA_AVBLE</span>

<span class="comments">;  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DHMI_VISU: STARTING LOOP OVER ALL COMBINATIONS TO FIND DATA'</span>
<span class="comments">;  FOR H=0,NOUTFS-1 DO BEGIN</span>
<span class="comments">;    FOR I=0,NSITES-1 DO BEGIN</span>
<span class="comments">;      FOR J=0,NSENSS-1 DO BEGIN</span>
<span class="comments">;        FOR K=0,NPROCV-1 DO BEGIN</span>
<span class="comments">;          TMP = '*'+SITE_SEARCH[H]+'*'+USITES[I]+'*_'+USENSS[J]+'_'+UPROCV[K]+'_*'</span>
<span class="comments">;          RES = STRMATCH(FILE_LIST,TMP) </span>
<span class="comments">;          IF TOTAL(RES) GT 0 THEN DATA_AVBLE[K,J,I,H]=1</span>
<span class="comments">;        ENDFOR</span>
<span class="comments">;      ENDFOR</span>
<span class="comments">;    ENDFOR</span>
<span class="comments">;  ENDFOR</span>

<span class="comments">;--------------------------</span>
<span class="comments">; DEFINE ARRAYS FOR CURRENTLY </span>
<span class="comments">; AVAILABLE CONFIGURATIONS AND INDEXES</span>
  
  VOUTF = SITE_SEARCH[0]
  IOUTF = 0

<span class="comments">;--------------------------</span>
<span class="comments">; GET AN ARRAY OF AVAILABLE </span>
<span class="comments">; SITES FOR THIS OUTPUTFOLDER</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DHMI_VISU: CREATING ARRAYS TO HOLD AVAILABLE INFORMATION'
  ASITES = USITES
  ASENSS = USENSS
  APROC = UPROCV
  NASITE=NSITES
  

<span class="comments">;--------------------------</span>
<span class="comments">; FIND AVAILABLE SITES</span>

<span class="comments">;  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DHMI_VISU: FINDING AVAILABLE SITES WITHIN OUTPUTFOLDER'</span>
<span class="comments">;  FOR I=0,NSITES-1 DO BEGIN </span>
<span class="comments">;  RES = TOTAL(DATA_AVBLE[*,*,I,IOUTF])</span>
<span class="comments">;    IF RES GT 0 THEN BEGIN</span>
<span class="comments">;      ASITES[NASITE]=USITES[I]</span>
<span class="comments">;      NASITE++</span>
<span class="comments">;    ENDIF</span>
<span class="comments">;  ENDFOR</span>

 <span class="comments">; ISITE = WHERE(USITES EQ ASITES[0])</span>
  ISITE = 0
  VSITE = USITES[ISITE]

<span class="comments">;--------------------------</span>
<span class="comments">; FIND AVAILABLE SENSORS</span>
 
  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DHMI_VISU: FINDING AVAILABLE SENSORS WITHIN SITE AND OUTPUTFOLDER' 
  NASENS=0
  NASENS=NSENSS 
<span class="comments">;  FOR J=0,NSENSS-1 DO BEGIN </span>
<span class="comments">;    RES = TOTAL(DATA_AVBLE[*,J,ISITE,IOUTF])</span>
<span class="comments">;    IF RES GT 0 THEN BEGIN</span>
<span class="comments">;      ASENSS[NASENS]=USENSS[J]</span>
<span class="comments">;      NASENS++</span>
<span class="comments">;    ENDIF</span>
<span class="comments">;  ENDFOR</span>

<span class="comments">;  ISENS = WHERE(USENSS EQ ASENSS[0])</span>
isens=0
  VSENS = USENSS[ISENS]

<span class="comments">;--------------------------</span>
<span class="comments">; FIND AVAILABLE PROCESSING VERSIONS</span>

  IF KEYWORD_SET(VERBOSE) THEN $
    PRINT,'DHMI_VISU: FINDING AVAILABLE PROC_VERSIONS WITHIN SENSOR, SITE AND OUTPUTFOLDER'
  NAPROC=0
  NAPROC=NPROCV
<span class="comments">;  FOR K=0,NPROCV-1 DO BEGIN </span>
<span class="comments">;    IF DATA_AVBLE[K,ISENS,ISITE,IOUTF] GT 0 THEN BEGIN</span>
<span class="comments">;      APROC[NAPROC]=UPROCV[K]</span>
<span class="comments">;      NAPROC++</span>
<span class="comments">;    ENDIF</span>
<span class="comments">;  ENDFOR</span>
<span class="comments">;</span>
<span class="comments">;  IPROC = WHERE(UPROCV EQ APROC[0])</span>
iproc = 0
  VPROC = UPROCV[IPROC]
  IOUTF = 0 & ISITE = 0 & ISENS = 0 & IPROC = 0

<span class="comments">;-----------------------------------------</span>
<span class="comments">; RETRIEVE THE SITE TYPE</span>

  SITE_TYPE = GET_SITE_TYPE(VSITE) 

<span class="comments">;-----------------------------------------</span>
<span class="comments">; MODISA SURFACE DEPENDANCE EXCEPTION</span>

  IF VSENS EQ 'MODISA' THEN BEGIN
    IF STRUPCASE(SITE_TYPE) EQ 'OCEAN' THEN TEMP_SENSOR = VSENS+'_O' ELSE TEMP_SENSOR = VSENS+'_L'
  ENDIF ELSE TEMP_SENSOR = VSENS

<span class="comments">;--------------------------</span>
<span class="comments">; GET A LIST OF ALL DIMITRI BANDS, </span>
<span class="comments">; FIND WHICH BANDS ARE AVAILABLE FOR THIS SENSOR</span>

  IF KEYWORD_SET(VERBOSE) THEN $
    PRINT,'DHMI_VISU: RETRIEVING LIST OF ALL DIMITRI BANDS AVAILABLE FOR SELECTED SENSOR'
  NB_BANDS = SENSOR_BAND_INFO(VSENS)
  DB_IDX = STRARR(NB_BANDS)
  TT=0
  FOR I=0,NB_BANDS[0]-1 DO BEGIN
    TMP = CONVERT_INDEX_TO_WAVELENGTH(I[0],TEMP_SENSOR)
    IF TMP NE 'ERROR' THEN BEGIN
      DB_IDX[TT] = STRTRIM(STRING(TT+1),2)+': '+TMP+' nm' 
      TT++
    ENDIF
  ENDFOR
  DB_IDX=DB_IDX[0:TT-1]

<span class="comments">;--------------------------</span>
<span class="comments">; DEFINE THE MAIN WIDGET INCLUDING </span>
<span class="comments">; FSC_FIELDS AND DROPLIST</span>

  DIMS  = GET_SCREEN_SIZE()
  XSIZE = 450
  YSIZE = 500
  OPT_BTN = 60
  XLOC  = (DIMS[0]/2)-(XSIZE/2)
  YLOC  = (DIMS[1]/2)-(YSIZE/2)

<span class="comments">;--------------------------</span>
<span class="comments">; DEFINE MAIN WIDGET</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DHMI_VISU: CREATING THE WIDGET TO CONTAIN ALL FIELDS AND BUTTONS'
  DHMI_VISU_TLB = WIDGET_BASE(COLUMN=1,TITLE='DIMITRI V2.0: VISU SETUP',XSIZE=XSIZE,XOFFSET=XLOC,YOFFSET=YLOC)
  DHMI_VISU_TLB_PAR     = WIDGET_BASE(DHMI_VISU_TLB,COLUMN=1,FRAME=1,/ALIGN_CENTER)

<span class="comments">;--------------------------</span>
<span class="comments">; DEFINE WIDGET LABEL</span>

  DHMI_VISU_TLB_PAR_TMP = WIDGET_LABEL(DHMI_VISU_TLB_PAR,VALUE='')
  DHMI_VISU_TLB_PAR_LBL = WIDGET_LABEL(DHMI_VISU_TLB_PAR,VALUE='VISUALISATION PARAMETERS :',/ALIGN_LEFT)
  DHMI_VISU_TLB_PAR_TMP = WIDGET_LABEL(DHMI_VISU_TLB_PAR,VALUE='')

<span class="comments">;--------------------------</span>
<span class="comments">; DEFINE WIDGET BASE TO HOLD FSC FIELDS</span>

  DHMI_VISU_TLB_PAR_FSC     = WIDGET_BASE(DHMI_VISU_TLB_PAR,ROW=5,XSIZE=XSIZE-15)

<span class="comments">;--------------------------</span>
<span class="comments">; DEFINE WIDGET FSC FIELDS AND BUTTONS</span>

  IF WIN_FLAG THEN DHMI_VISU_TLB_PAR_FSC_OID  = FSC_FIELD(DHMI_VISU_TLB_PAR_FSC, TITLE='FOLDER          : ', VALUE=VOUTF,OBJECT=FSCOUTF,/NOEDIT,XSIZE=45) $
    ELSE DHMI_VISU_TLB_PAR_FSC_OID  = FSC_FIELD(DHMI_VISU_TLB_PAR_FSC, TITLE='FOLDER     : ', VALUE=VOUTF,OBJECT=FSCOUTF,/NOEDIT,XSIZE=45)
  DHMI_VISU_TLB_PAR_FSC_TMP  = WIDGET_BUTTON(DHMI_VISU_TLB_PAR_FSC,VALUE='&lt;',$
                                              UVALUE= 'OUTF&lt;',EVENT_PRO='DHMI_VISU_CHANGE')
  DHMI_VISU_TLB_PAR_FSC_TMP  = WIDGET_BUTTON(DHMI_VISU_TLB_PAR_FSC,VALUE='>',$
                                              UVALUE= 'OUTF>',EVENT_PRO='DHMI_VISU_CHANGE') 

  IF WIN_FLAG THEN DHMI_VISU_TLB_PAR_FSC_RID  = FSC_FIELD(DHMI_VISU_TLB_PAR_FSC, TITLE='REGION          : ', VALUE=VSITE,OBJECT=FSCSITE,/NOEDIT) $
    ELSE DHMI_VISU_TLB_PAR_FSC_RID  = FSC_FIELD(DHMI_VISU_TLB_PAR_FSC, TITLE='REGION     : ', VALUE=VSITE,OBJECT=FSCSITE,/NOEDIT)
  DHMI_VISU_TLB_PAR_FSC_TMP  = WIDGET_BUTTON(DHMI_VISU_TLB_PAR_FSC,VALUE='&lt;',$
                                              UVALUE= 'RSITE&lt;',EVENT_PRO='DHMI_VISU_CHANGE')
  DHMI_VISU_TLB_PAR_FSC_TMP  = WIDGET_BUTTON(DHMI_VISU_TLB_PAR_FSC,VALUE='>',$
                                              UVALUE= 'RSITE>',EVENT_PRO='DHMI_VISU_CHANGE') 

  IF WIN_FLAG THEN DHMI_VISU_TLB_PAR_FSC_SID  = FSC_FIELD(DHMI_VISU_TLB_PAR_FSC, TITLE='REF SENSOR : ', VALUE=VSENS,OBJECT=FSCSENS,/NOEDIT) $
    ELSE DHMI_VISU_TLB_PAR_FSC_SID  = FSC_FIELD(DHMI_VISU_TLB_PAR_FSC, TITLE='REF SENSOR : ', VALUE=VSENS,OBJECT=FSCSENS,/NOEDIT)
  DHMI_VISU_TLB_PAR_FSC_TMP  = WIDGET_BUTTON(DHMI_VISU_TLB_PAR_FSC,VALUE='&lt;',$
                                              UVALUE= 'SENSOR&lt;',EVENT_PRO='DHMI_VISU_CHANGE')
  DHMI_VISU_TLB_PAR_FSC_TMP  = WIDGET_BUTTON(DHMI_VISU_TLB_PAR_FSC,VALUE='>',$
                                              UVALUE= 'SENSOR>',EVENT_PRO='DHMI_VISU_CHANGE') 

  IF WIN_FLAG THEN DHMI_VISU_TLB_PAR_FSC_PID  = FSC_FIELD(DHMI_VISU_TLB_PAR_FSC, TITLE='PROC_VER     : ', VALUE=VPROC,OBJECT=FSCPROC,/NOEDIT) $
    ELSE DHMI_VISU_TLB_PAR_FSC_PID  = FSC_FIELD(DHMI_VISU_TLB_PAR_FSC, TITLE='PROC_VER   : ', VALUE=VPROC,OBJECT=FSCPROC,/NOEDIT)
  DHMI_VISU_TLB_PAR_FSC_TMP  = WIDGET_BUTTON(DHMI_VISU_TLB_PAR_FSC,VALUE='&lt;',$
                                              UVALUE= 'PROC&lt;',EVENT_PRO='DHMI_VISU_CHANGE')
  DHMI_VISU_TLB_PAR_FSC_TMP  = WIDGET_BUTTON(DHMI_VISU_TLB_PAR_FSC,VALUE='>',$
                                              UVALUE= 'PROC>',EVENT_PRO='DHMI_VISU_CHANGE') 

  IF WIN_FLAG THEN DHMI_VISU_TLB_PAR_FSC_TMP  = WIDGET_LABEL(DHMI_VISU_TLB_PAR_FSC,VALUE=' REF BAND  : ') $
    ELSE DHMI_VISU_TLB_PAR_FSC_TMP  = WIDGET_LABEL(DHMI_VISU_TLB_PAR_FSC,VALUE=' REF BAND  : ')
  DHMI_VISU_TLB_PAR_DRPID    = WIDGET_DROPLIST(DHMI_VISU_TLB_PAR_FSC, VALUE=DB_IDX, UVALUE=DB_IDX,$
                                              EVENT_PRO='DHMI_VISU_DROPLIST')
  <span class="comments">;DHMI_VISU_TLB_PAR_FSC_TMP  = WIDGET_LABEL(DHMI_VISU_TLB_PAR_FSC,VALUE='') </span>

<span class="comments">;--------------------------</span>
<span class="comments">; DEFINE WIDGET BASE IN MAIN</span>

  DHMI_VISU_TLB_PAR_OPT      = WIDGET_BASE(DHMI_VISU_TLB,ROW=1,/ALIGN_RIGHT)

<span class="comments">;--------------------------</span>
<span class="comments">; DEFINE TWO BUTTONS FOR START AND CLOSE</span>

  DHMI_VISU_TLB_PAR_OPT_BTN  = WIDGET_BUTTON(DHMI_VISU_TLB_PAR_OPT,VALUE='Start',$  
                                              UVALUE='START',EVENT_PRO='DHMI_VISU_START',XSIZE=OPT_BTN)
  DHMI_VISU_TLB_PAR_OPT_BTN  = WIDGET_BUTTON(DHMI_VISU_TLB_PAR_OPT,VALUE='Close',EVENT_PRO='DHMI_VISU_EXIT',XSIZE=OPT_BTN)

<span class="comments">;--------------------------</span>
<span class="comments">; DEFINE STRUCTURE TO HOLD ALL DATA FOR WIDGET</span>

  IF KEYWORD_SET(VERBOSE) THEN $
    PRINT,'DHMI_VISU: CREATEING STRUCTURE TO HOLD ALL REQUIRED WIDGET INFORMATION'
  IF NOT KEYWORD_SET(GROUP_LEADER) THEN GROUP_LEADER = DHMI_VISU_TLB
  DHMI_VISU_INFO = {                                      $
                  IVERBOSE      : IVERBOSE                ,$
                  GROUP_LEADER  : GROUP_LEADER            ,$
                  VISU_OFOLDER  : VISU_OFOLDER            ,$
                  DL            : DL                      ,$
                  CDIR          : CDIR                    ,$       
                  FSCOUTF       : FSCOUTF                 ,$
                  FSCSITE       : FSCSITE                 ,$
                  FSCSENS       : FSCSENS                 ,$
                  FSCPROC       : FSCPROC                 ,$
                  USITES        : USITES                  ,$
                  USENSS        : USENSS                  ,$
                  UPROCV        : UPROCV                  ,$   
                  NASITE        : NASITE                  ,$
                  NAPROC        : NAPROC                  ,$
                  NASENS        : NASENS                  ,$
                  NOUTFS        : NOUTFS                  ,$
                  NSITES        : NSITES                  ,$
                  NSENSS        : NSENSS                  ,$
                  NPROCV        : NPROCV                  ,$
                  DATA_AVBLE    : DATA_AVBLE              ,$
                  AOUTF         : SITE_SEARCH             ,$
                  VOUTF         : VOUTF                   ,$
                  IOUTF         : IOUTF                   ,$
                  ASITES        : ASITES                  ,$
                  ISITE         : ISITE                   ,$
                  VSITE         : VSITE                   ,$
                  ASENSS        : ASENSS                  ,$
                  ISENS         : ISENS                   ,$
                  VSENS         : VSENS                   ,$
                  APROC         : APROC                   ,$
                  IPROC         : IPROC                   ,$
                  VPROC         : VPROC                   ,$
                  DROPID        : DHMI_VISU_TLB_PAR_DRPID $
                 }

<span class="comments">;--------------------------</span>
<span class="comments">; REALISE THE WIDGET AND REGISTER WITH THE XMANAGER</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DHMI_VISU: REALISING THE WIDGET AND REGISTERING WITH THE XMANAGER'
  WIDGET_CONTROL,DHMI_VISU_TLB,/REALIZE,/NO_COPY,SET_UVALUE=DHMI_VISU_INFO,GROUP_LEADER=GROUP_LEADER
  XMANAGER,'DHMI_VISU', DHMI_VISU_TLB

END
</code>
    </div>
  </body>
</html>