<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Tue Jul  2 12:50:41 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>aatsr_remove_drift_correction.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="aatsr_remove_drift_correction.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+</span>
<span class="comments">;FILE: AATSR_REMOVE_DRIFT_CORRECTION.PRO</span>
<span class="comments">;DESCRIPTION</span>
<span class="comments">; Identifies which calibration drift correction is used in AATSR L1B reflectance</span>
<span class="comments">;</span>
<span class="comments">; VC1 file generation date indicates which drift correction has been applied.</span>
<span class="comments">;     Date before 29-Nov-2005 13:20:26  then no correction applied</span>
<span class="comments">;     Date between 29-Nov-2005 13:20:26 and 18-Dec-2006 20:14:15 then exponential drift correction is applied</span>
<span class="comments">;     Date after 18-Dec-2006 20:14:15 then thin film correction is applied</span>
<span class="comments">;</span>
<span class="comments">;ORIGINAL: 16-Jan-2008</span>
<span class="comments">;</span>
<span class="comments">;MODIFICATION:  14-July-2010 - Following a system crash on 4th April 2010 - All VC1 files generated over the period </span>
<span class="comments">;               between 04-April-2010 and 12-July-2010 inclusive did NOT contain any drift correction - hence this function was </span>
<span class="comments">;               incorrectly removing the corrections.  A fix has been implemented to perform no modification to L1b reflectances</span>
<span class="comments">;               where VC1 files generated during that period.</span>
<span class="comments">;</span>
<span class="comments">;IMPORT: VC1_FILENAME - String containing name of GC1 filename associated with L1B product - DSD31 in product</span>
<span class="comments">;        ACQ_TIME - String containing acquistion time of product - format = DD-MMM-YYYY HH:MM:SS</span>
<span class="comments">;        ICH - Integer Variable Containing Channel Number to be processed</span>
<span class="comments">;               0 = 555nm</span>
<span class="comments">;               1 = 659nm</span>
<span class="comments">;               2 = 870nm</span>
<span class="comments">;               3 = 1600nm</span>
<span class="comments">;        REFLECTANCE - Variable containing reflectance reading from L1B product</span>
<span class="comments">;</span>
<span class="comments">;EXPORT: UNCORRECTED - Variable containing reflectance reading with drift correction removed.  If an invalid</span>
<span class="comments">;                      channel is specified or the date precedes the launch then an error is reported and -1 is</span>
<span class="comments">;                      set as the return value</span>
<span class="comments">;</span>
<span class="comments">;***************************************************************************************************************</span>
FUNCTION AATSR_REMOVE_DRIFT_CORRECTION,VC1_FILENAME,ACQ_TIME,ICH,REFLECTANCE

    V56 = 0
    V66 = 1
    V87 = 2
    V16 = 3

    ERROR = -1

    IF(ICH GT 3)THEN BEGIN
       PRINT,'ERROR: Channel out of range - no correction applied'
       RETURN,ERROR        <span class="comments">;Return error value</span>
    ENDIF

    MONTHSTR = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC']

    T0 = TIMESTR_TO_JULDAY('01-MAR-2002 00:00:00') <span class="comments">;Envisat launch date - converted to julian time</span>
    T = TIMESTR_TO_JULDAY(ACQ_TIME)                <span class="comments">;Image acquisition time - converted to julian time</span>

    IF(T LT T0)THEN BEGIN
       PRINT,'ERROR: Acquisition time before ENVISAT launch date = ',ACQ_TIME
       RETURN,ERROR
    ENDIF

    K = [0.034, 0.021, 0.013, 0.002]                <span class="comments">;yearly drift rates for exponential drift</span>

    A = [[0.083,  1.5868E-3], $                    <span class="comments">;Thin film drift model coefficients</span>
         [0.056,  1.2374E-3], $
         [0.041,  9.6111E-4] ]

<span class="comments">;******************************************************************************************************************************</span>
<span class="comments">;Find out which drift correction has been applied - uses date of VC1</span>
<span class="comments">;VC1 time</span>
   year = strmid(vc1_filename,14,4)
   month = monthstr(fix(strmid(vc1_filename,18,2))-1)
   day = strmid(vc1_filename,20,2)
   hour = strmid(vc1_filename,23,2)
   mins = strmid(vc1_filename,25,2)
   secs = strmid(vc1_filename,27,2)

   PROC_TIME = DAY+'-'+MONTH+'-'+YEAR+' '+HOUR+':'+MINS+':'+SECS
   PROC_TIME = TIMESTR_TO_JULDAY(PROC_TIME)

<span class="comments">;Now Identify Which Correction Has Been Applied</span>
   IF((PROC_TIME LT TIMESTR_TO_JULDAY('29-NOV-2005 13:20:26')) OR $
      ((PROC_TIME GE TIMESTR_TO_JULDAY('04-APR-2010 00:00:00')) AND $
       (PROC_TIME LT TIMESTR_TO_JULDAY('13-JUL-2010 00:00:00'))) $
      )THEN BEGIN
     CORRECTION = 0     <span class="comments">;NO Drift Correction Applied</span>
     
   ENDIF ELSE IF((PROC_TIME GE TIMESTR_TO_JULDAY('29-NOV-2005 13:20:26')) AND $
                 (PROC_TIME LT TIMESTR_TO_JULDAY('18-DEC-2006 20:14:15')) $
                )THEN BEGIN
     CORRECTION = 1     <span class="comments">;Exponential Drift Correction is Applied</span>
   ENDIF ELSE BEGIN
     CORRECTION = 2     <span class="comments">;Thin Film Drift Correction is Applied</span>
   ENDELSE

<span class="comments">;Now remove corrections if applied</span>

<span class="comments">;No correction applied</span>
        IF(CORRECTION EQ 0)THEN $
           DRIFT = 1.0


<span class="comments">;Exponential drift correction</span>
        IF(((ICH EQ V16) AND (CORRECTION NE 0)) OR $
           ((ICH NE V16) AND (CORRECTION EQ 1)))THEN $
           DRIFT = EXP(K(ICH)*(T-T0)/365.0)


<span class="comments">;Thin film correction</span>
        IF(((ICH NE V16) AND (CORRECTION EQ 2)))THEN $
           DRIFT = 1.0 + A(0,ICH)*SIN(A(1,ICH)*(T-T0))^2


<span class="comments">;Now multiply reflectance by drift to get uncorrected value</span>
       UNCORRECTED = REFLECTANCE*DRIFT

<span class="comments">;And we are done</span>
RETURN,UNCORRECTED
END
</code>
    </div>
  </body>
</html>