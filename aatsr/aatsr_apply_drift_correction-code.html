<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Tue Jul  2 12:50:41 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>aatsr_apply_drift_correction.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="aatsr_apply_drift_correction.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+</span>
<span class="comments">;FILE: AATSR_APPLY_DRIFT_CORRECTION.PRO</span>
<span class="comments">;DESCRIPTION</span>
<span class="comments">;     Uses drift correction look up table to obtain the drift measurement for a given channel and acquisition</span>
<span class="comments">;     time.</span>
<span class="comments">;     WARNING: All previous drift corrections must be removed before using this function. This is performed using</span>
<span class="comments">;     the function AATSR_REMOVE_DRIFT_CORRECTION.</span>
<span class="comments">;</span>
<span class="comments">;ORIGINAL: 16-Jan-2008</span>
<span class="comments">;Modification: 11-Mar-2008 - Option included to show error messages</span>
<span class="comments">;</span>
<span class="comments">;IMPORT: ACQ_TIME - String containing acquistion time of product - format = DD-MMM-YYYY HH:MM:SS</span>
<span class="comments">;        ICH - Integer Variable Containing Channel Number to be processed</span>
<span class="comments">;               0 = 555nm</span>
<span class="comments">;               1 = 659nm</span>
<span class="comments">;               2 = 870nm</span>
<span class="comments">;               3 = 1600nm</span>
<span class="comments">;        REFLECTANCE - Variable containing reflectance reading from L1B product</span>
<span class="comments">;        DRIFT_TABLE - If specified, a structure containing the drift look up table</span>
<span class="comments">;</span>
<span class="comments">;</span>
<span class="comments">;EXPORT: CORRECTED - Variable containing reflectance reading with drift correction Applied  If an invalid</span>
<span class="comments">;                      channel is specified or the date precedes the launch then an error is reported and -1 is</span>
<span class="comments">;                      set as the return value</span>
<span class="comments">;</span>
<span class="comments">;***************************************************************************************************************</span>
FUNCTION AATSR_APPLY_DRIFT_CORRECTION,ACQ_TIME,ICH,REFLECTANCE,DRIFT_TABLE=DRIFT_TABLE,SHOW_ERROR=SHOW_ERROR

    V56 = 0
    V66 = 1
    V87 = 2
    V16 = 3

    ERROR = -1
    
    IF(N_ELEMENTS(SHOW_ERROR) EQ 0)THEN SHOW_ERROR = 0

    IF(ICH GT 3)THEN BEGIN
       IF(SHOW_ERROR)THEN PRINT,'ERROR: Channel out of range - no correction applied'
       RETURN,ERROR        <span class="comments">;Return error value</span>
    ENDIF

    MONTHSTR = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC']

    T0 = TIMESTR_TO_JULDAY('01-MAR-2002 00:00:00')    <span class="comments">;Envisat launch date - converted to julian time</span>
    TIME = TIMESTR_TO_JULDAY(ACQ_TIME)                <span class="comments">;Image acquisition time - converted to julian time</span>

    IF(TIME LT T0)THEN BEGIN
       IF(SHOW_ERROR)THEN PRINT,'ERROR: Acquisition time before ENVISAT launch date = ',ACQ_TIME
       RETURN,ERROR
    ENDIF

<span class="comments">;If the table is not passed in the function call, read the table</span>
    IF((N_ELEMENTS(DRIFT_TABLE) EQ 0) OR (SIZE(DRIFT_TABLE,/TNAME) NE 'STRUCT'))THEN BEGIN
       NTAB = AATSR_READ_DRIFT_TABLE(DRIFT_TABLE)
       IF(NTAB EQ -1)THEN BEGIN
          IF(SHOW_ERROR)THEN PRINT,'ERROR: Unable to read drift correction LUT'
          RETURN,-1
       ENDIF
    ENDIF

    IF(TIME LT DRIFT_TABLE.DATE_JUL(0))THEN BEGIN
      IF(SHOW_ERROR)THEN PRINT,'ERROR: Acquisition before start time of table'
      RETURN,-1
    ENDIF


    IF(TIME GT DRIFT_TABLE.DATE_JUL(DRIFT_TABLE.NTAB-1))THEN BEGIN
      IF(SHOW_ERROR)THEN PRINT,'ERROR: Acquisition after last entry in table'
      RETURN,-1
    ENDIF

<span class="comments">;Now interpolate table to get drift value</span>
    TAB_DATES = DRIFT_TABLE.DATE_JUL(0:DRIFT_TABLE.NTAB-1)
    CASE(ICH)OF
       0: DRIFT_ARRAY = DRIFT_TABLE.V56_DRIFT(0:DRIFT_TABLE.NTAB-1)
       1: DRIFT_ARRAY = DRIFT_TABLE.V67_DRIFT(0:DRIFT_TABLE.NTAB-1)
       2: DRIFT_ARRAY = DRIFT_TABLE.V87_DRIFT(0:DRIFT_TABLE.NTAB-1)
       3: DRIFT_ARRAY = DRIFT_TABLE.V16_DRIFT(0:DRIFT_TABLE.NTAB-1)
    ENDCASE
    DRIFT = INTERPOL(DRIFT_ARRAY,TAB_DATES,TIME)

<span class="comments">;Now multiply reflectance by drift to get uncorrected value</span>
       CORRECTED = REFLECTANCE/DRIFT

<span class="comments">;And we are done</span>
RETURN,CORRECTED
END
</code>
    </div>
  </body>
</html>