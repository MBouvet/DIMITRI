<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Tue Jul  2 12:50:44 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>cloud_module_vgt.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="cloud_module_vgt.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;*</span>
<span class="comments">;* NAME:</span>
<span class="comments">;*      CLOUD_MODULE_VGT </span>
<span class="comments">;* </span>
<span class="comments">;* PURPOSE:</span>
<span class="comments">;*      THIS FUNCTION PERFORMS THE OPERATIONAL VEGETATION CLOUD SCREENING TEST ON A </span>
<span class="comments">;*      GIVEN ARRAY F SPECTRAL DATA. THE ALGORITHM FOR THE TEST IS DESCRIBED IN </span>
<span class="comments">;*      "DEVELOPMENT OF A CLOUD,SNOW AND CLOUD SHADOW MASK FOR VEGETATION IMAGERY" </span>
<span class="comments">;*      BY G LISSENS, P KEMPENEERS AND F FIERENS</span>
<span class="comments">;* </span>
<span class="comments">;* CALLING SEQUENCE:</span>
<span class="comments">;*      PIXEL_MASK = CLOUD_MODULE_VGT(SITE_TYPE,VGT_REF)</span>
<span class="comments">;* </span>
<span class="comments">;* INPUTS:</span>
<span class="comments">;*      SITE_TYPE - A STRING OF THE DIMITRI VALIDATION SITE TYPE (E.G. 'OCEANIC')</span>
<span class="comments">;*      VGT_REF   - A FLOAT ARRAY OF THE TOP OF ATMOSPHERE REFLECTANCE AT THE VEGETATION </span>
<span class="comments">;*                  WAVEBANDS, OF THE FORM [NUM_PIXELS,NUM_BANDS]     </span>
<span class="comments">;*</span>
<span class="comments">;* KEYWORDS:</span>
<span class="comments">;*      VERBOSE  - PROCESSING STATUS OUTPUTS</span>
<span class="comments">;*</span>
<span class="comments">;* OUTPUTS:</span>
<span class="comments">;*      PIXEL_MASK - A INTEGER OF SIZE NUM_PIXELS, 0S MEAN CLEAR PIXEL, 1 MEANS CLOUDY</span>
<span class="comments">;*</span>
<span class="comments">;* COMMON BLOCKS:</span>
<span class="comments">;*      NONE</span>
<span class="comments">;*</span>
<span class="comments">;* MODIFICATION HISTORY:</span>
<span class="comments">;*      01 APR 2011 - C KENT    - DIMITRI-2 V1.0</span>
<span class="comments">;*      07 APR 2011 - C KENT    - ADDED BAND INDEX VALUES</span>
<span class="comments">;*</span>
<span class="comments">;* VALIDATION HISTORY:</span>
<span class="comments">;*      12 APR 2011 - C KENT    - NOMINAL COMPILATION AND OPERATION ON WINDOWS 32BIT </span>
<span class="comments">;*                                IDL 7.1 AND LINUX 64BIT IDL 8.0        </span>
<span class="comments">;*</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

FUNCTION CLOUD_MODULE_VGT,SITE_TYPE,VGT_REF,VERBOSE=VERBOSE

<span class="comments">;-----------------------</span>
<span class="comments">; DEFINE NUMBER OF PIXELS </span>
<span class="comments">; AND PIXEL/SNOW MASK ARRAYS</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'CLOUD_MODULE_VGT: STARTING CLOUD SCREENING TESTS'
  NUM_PIXELS  = N_ELEMENTS(VGT_REF[*,0])
  PIXEL_MASK  = INTARR(NUM_PIXELS)-1
  SNOW_MASK   = INTARR(NUM_PIXELS)
  
  B1 = 0
  B2 = 1
  B3 = 2
  B4 = 3

<span class="comments">;-----------------------</span>
<span class="comments">; DEFINE CLOUD SCREENING FLAG VALUES</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'CLOUD_MODULE_VGT: DEFINING FLAGS'
  CLEAR_FLAG      = 0
  CLOUDY_FLAG     = 1
  SNOW_FLAG       = 2

  CASE STRUPCASE(SITE_TYPE) OF
    'ICE'   : UNCERTAIN_FLAG  = CLEAR_FLAG
    'SNOW'  : UNCERTAIN_FLAG  = CLEAR_FLAG
    'DESERT': UNCERTAIN_FLAG  = CLEAR_FLAG
    'SALT'  : UNCERTAIN_FLAG  = CLEAR_FLAG
    ELSE    : UNCERTAIN_FLAG  = CLOUDY_FLAG
  ENDCASE

<span class="comments">;-----------------------</span>
<span class="comments">; DEFINE CLOUD SCREENING THRESHOLDS</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'CLOUD_MODULE_VGT: DEFINING THRESHOLDS'
  THRESHOLD_SF = 0.0005

  THRESH_1BLUE = 493.0
  THRESH_1SWIR = 180.0
  THRESH_2BLUE = 720.0
  THRESH_2SWIR = 320.0

  THRESH_SNOW_RED = 615.0
  THRESH_SNOW_MIR = 481.0
  THRESH_SNOW_1   = -773.0
  THRESH_SNOW_2   = 87.0
  THRESH_SNOW_3   = 77.0

<span class="comments">;-----------------------</span>
<span class="comments">; TEST 1: CLEAR PIXEL TEST</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'CLOUD_MODULE_VGT: RUNNING CLEAR PIXEL TEST'  
  CLEAR_PIXELS = WHERE( VGT_REF[*,B1] LT THRESH_1BLUE*THRESHOLD_SF OR $
                        VGT_REF[*,B4] LT THRESH_1SWIR*THRESHOLD_SF ,COUNT)

  IF CLEAR_PIXELS[0] GT -1 THEN PIXEL_MASK[CLEAR_PIXELS] = CLEAR_FLAG

<span class="comments">;-----------------------</span>
<span class="comments">; TEST 2: CLOUDY PIXEL TEST</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'CLOUD_MODULE_VGT: RUNNING CLOUDY PIXEL TEST' 
  CLOUDY_PIXELS = WHERE(PIXEL_MASK   NE CLEAR_FLAG                  AND $
                       (VGT_REF[*,B1] GE THRESH_2BLUE*THRESHOLD_SF   OR  $
                        VGT_REF[*,B4] GE THRESH_2SWIR*THRESHOLD_SF) ,COUNT)

  IF CLOUDY_PIXELS[0] GT -1 THEN PIXEL_MASK[CLOUDY_PIXELS] = CLOUDY_FLAG

<span class="comments">;-----------------------</span>
<span class="comments">; TEST 2: UNCERTAIN PIXEL TEST</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'CLOUD_MODULE_VGT: RESETTING UNCERTAIN FLAGS'   
  UNCERTAIN_PIXELS = WHERE(PIXEL_MASK NE CLEAR_FLAG AND PIXEL_MASK NE CLOUDY_FLAG, COUNT)
  IF UNCERTAIN_PIXELS[0] GT -1 THEN PIXEL_MASK[UNCERTAIN_PIXELS] = UNCERTAIN_FLAG

<span class="comments">;-----------------------</span>
<span class="comments">; SNOW TEST</span>

  IF STRUPCASE(SITE_TYPE) EQ 'OCEANIC' THEN GOTO,SKIP_SNOW_TEST

<span class="comments">;-----------------------</span>
<span class="comments">; SNOW TEST PART 1</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'CLOUD_MODULE_VGT: STARTING PART 1 OF SNOW TEST' 
  SNOW1 = WHERE(VGT_REF[*,B2] GE THRESH_SNOW_RED*THRESHOLD_SF AND $
                VGT_REF[*,B4] LT THRESH_SNOW_MIR*THRESHOLD_SF )

  IF SNOW1[0] EQ -1 THEN GOTO,SKIP_SNOW_TEST
  SNOW_MASK[SNOW1] = SNOW_FLAG

<span class="comments">;-----------------------</span>
<span class="comments">; SNOW TEST PART 2</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'CLOUD_MODULE_VGT: STARTING PART 2 OF SNOW TEST' 
  VAR1 = 1000*(VGT_REF[*,B1]-VGT_REF[*,B3])/(VGT_REF[*,B1]+VGT_REF[*,B3])
  VAR2 = 1000*(VGT_REF[*,B1]-VGT_REF[*,B4])/(VGT_REF[*,B1]+VGT_REF[*,B4])
  VAR3 = ((VGT_REF[*,B1]+VGT_REF[*,B2])/2.0)-VGT_REF[*,B4]

  SNOW2 = WHERE(SNOW_MASK EQ SNOW_FLAG                  AND $
                VAR1      GE THRESH_SNOW_1              AND $
                VAR2      GE THRESH_SNOW_2              AND $
                VAR3      GE THRESH_SNOW_3*THRESHOLD_SF )

  IF SNOW2[0] GT -1 THEN PIXEL_MASK[SNOW2] = CLEAR_FLAG <span class="comments">;PIXELS ARE SNOW AND NOT CLOUD!</span>

<span class="comments">;-----------------------</span>
<span class="comments">; SET NON-CLOUD PIXELS TO CLEAR AND RETURN</span>

  SKIP_SNOW_TEST:
  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'CLOUD_MODULE_VGT: RETURNING CLOUD MASK' 
  RES = WHERE(PIXEL_MASK NE CLOUDY_FLAG)
  IF RES[0] GT -1 THEN PIXEL_MASK[RES] = CLEAR_FLAG

  RETURN,PIXEL_MASK

END
</code>
    </div>
  </body>
</html>