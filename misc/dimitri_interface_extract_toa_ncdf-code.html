<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Tue Jul  2 12:50:56 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>dimitri_interface_extract_toa_ncdf.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="dimitri_interface_extract_toa_ncdf.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;*</span>
<span class="comments">;* NAME:</span>
<span class="comments">;*      DIMITRI_INTERFACE_EXTRACT_TOA_NCDF   </span>
<span class="comments">;* </span>
<span class="comments">;* PURPOSE:</span>
<span class="comments">;*      THIS FUNCTION EITHER OUTPUTS A NEW NETCDF INTERNAL FILE, OR MERGES THE DATA </span>
<span class="comments">;*      PROVIDED WITH THE EXISTING FILE</span>
<span class="comments">;*</span>
<span class="comments">;* CALLING SEQUENCE:</span>
<span class="comments">;*      RES = DIMITRI_INTERFACE_EXTRACT_TOA_NCDF(SENSOR_TOA_DATA,NCDF_FILENAME)</span>
<span class="comments">;* </span>
<span class="comments">;* INPUTS:</span>
<span class="comments">;*      SENSOR_TOA_DATA - A STRUCTURE CONTAING THE REQUIRED OUTPUT INFORMATION (SEE GET_DIMITRI_EXTRACT_NCDF_DATA_STRUCTURE)</span>
<span class="comments">;*      NCDF_FILENAME   - THE FULLY QUALIFIED PATH OF THE OUTPUT FILENAME</span>
<span class="comments">;*</span>
<span class="comments">;* KEYWORDS:</span>
<span class="comments">;*      VERBOSE   - PROCESSING STATUS OUTPUTS</span>
<span class="comments">;*</span>
<span class="comments">;* OUTPUTS:</span>
<span class="comments">;*      STATUS    - 0 IS NOMINAL, 1 SOME KIND OF ERROR ENCOUNTERED</span>
<span class="comments">;*</span>
<span class="comments">;* COMMON BLOCKS:</span>
<span class="comments">;*      NONE</span>
<span class="comments">;*</span>
<span class="comments">;* MODIFICATION HISTORY:</span>
<span class="comments">;*      23 AUG 2011 - C KENT   - DIMITRI-2 V1.0</span>
<span class="comments">;*      30 AUG 2011 - C KENT   - ADDED MANUAL CLOUD SCREENING OUTPUT TO NETCDF</span>
<span class="comments">;*</span>
<span class="comments">;* VALIDATION HISTORY:</span>
<span class="comments">;*      </span>
<span class="comments">;*</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

FUNCTION DIMITRI_INTERFACE_EXTRACT_TOA_NCDF,SENSOR_TOA_DATA,NCDF_FILENAME,VERBOSE=VERBOSE

<span class="comments">;-----------------------------------</span>
<span class="comments">; DEFINE NEW VARIABLES INCLUDING DATE</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DIMITRI_INTERFACE_EXTRACT_TOA_NCDF: STARTING NETCDF INTERFACE'
  TB_STR = '_TEMP_BACKUP'
  CALDAT, SYSTIME(/UTC,/JULIAN),TMM,TDD,TYY,THR,TMN,TSS

  TYY = STRTRIM(STRING(TYY),2)
  TMM = TMM LT 10 ? '0'+STRTRIM(STRING(TMM),2) : STRTRIM(STRING(TMM),2)
  TDD = TDD LT 10 ? '0'+STRTRIM(STRING(TDD),2) : STRTRIM(STRING(TDD),2)
  THR = THR LT 10 ? '0'+STRTRIM(STRING(THR),2) : STRTRIM(STRING(THR),2)
  TMN = TMN LT 10 ? '0'+STRTRIM(STRING(TMN),2) : STRTRIM(STRING(TMN),2)
  TSS = TSS LT 10 ? '0'+STRTRIM(STRING(TSS,FORMAT='(I)'),2) : STRTRIM(STRING(TSS,FORMAT='(I)'),2)

  CDATE = TYY+TMM+TDD+' '+THR+':'+TMN+':'+TSS
  MDATE = CDATE

<span class="comments">;-----------------------------------</span>
<span class="comments">; READ THE CURRENT NETCDF PRODUCT</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DIMITRI_INTERFACE_EXTRACT_TOA_NCDF: READING THE CURRENT NETCDF PRODUCT'
  NCDF_DATA = READ_DIMITRI_EXTRACT_TOA_NCDF(NCDF_FILENAME,VERBOSE=VERBOSE)

<span class="comments">;-----------------------------------</span>
<span class="comments">; GET LISTS OF ALL TAG NAMES</span>

  IDATA_TAG   = TAG_NAMES(SENSOR_TOA_DATA)
  NDATA_TAG   = TAG_NAMES(NCDF_DATA)
  TEMP_STRUCT = {TT:0} 

<span class="comments">;-----------------------------------</span>
<span class="comments">; LOOP OVER EACH VARIABLE AND MERGE IF PREVIOUS FILE EXISTS</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DIMITRI_INTERFACE_EXTRACT_TOA_NCDF: LOOPING OVER EACH VARIABLE, AND MERGING IF NEEDED'
  FOR IDIE=0,N_ELEMENTS(IDATA_TAG)-1 DO BEGIN
    IF NCDF_DATA.ERROR EQ 0 THEN BEGIN
      IDIMS = SIZE(SENSOR_TOA_DATA.(IDIE))
      IDX = WHERE(NDATA_TAG EQ IDATA_TAG[IDIE],COUNT)
      IF COUNT EQ 0 OR IDIMS[0] EQ 0 THEN GOTO,NO_MATCH
      IF IDIMS[0] EQ 1 THEN BEGIN
        NDIMS = SIZE(NCDF_DATA.(IDX[0]))
        IF IDIMS[0] NE NDIMS[0] THEN DATA = STRING(NCDF_DATA.(IDX[0])) ELSE DATA = NCDF_DATA.(IDX[0])
        ADDDATA = [SENSOR_TOA_DATA.(IDIE),DATA]
      <span class="comments">;ENDIF ELSE IF IDIMS[0] EQ 2 THEN ADDDATA = [[SENSOR_TOA_DATA.(IDIE)],[NCDF_DATA.(IDX[0])]]</span>
      ENDIF ELSE ADDDATA = [[SENSOR_TOA_DATA.(IDIE)],[NCDF_DATA.(IDX[0])]]
      TEMP_STRUCT = CREATE_STRUCT(TEMP_STRUCT,IDATA_TAG[IDIE],ADDDATA)
    ENDIF ELSE BEGIN
      NO_MATCH:
      TEMP_STRUCT = CREATE_STRUCT(TEMP_STRUCT,IDATA_TAG[IDIE],SENSOR_TOA_DATA.(IDIE))
    ENDELSE
  ENDFOR

<span class="comments">;-----------------------------------</span>
<span class="comments">; UPDATE MODIFICATION DATE AND CREATION DATE IF REQUIRED</span>

  TEMP_STRUCT.ATT_MTIME = MDATE
  IF NCDF_DATA.ERROR EQ 0 THEN TEMP_STRUCT.ATT_CTIME = STRING(NCDF_DATA.ATT_CTIME) ELSE TEMP_STRUCT.ATT_CTIME = CDATE

<span class="comments">;-----------------------------------</span>
<span class="comments">; COPY OLD FILE TO A TEMP LOCATION & </span>
<span class="comments">; DELETE THE OLD FILE</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DIMITRI_INTERFACE_EXTRACT_TOA_NCDF: REMOVING PREVIOUS COPY IF PRESENT AND CREATING TEMP BACKUP'
  IF NCDF_DATA.ERROR EQ 0 THEN BEGIN
    FILE_COPY,NCDF_FILENAME,NCDF_FILENAME+TB_STR
    FILE_DELETE,NCDF_FILENAME
  ENDIF

<span class="comments">;-----------------------------------</span>
<span class="comments">; SEND THE DATA STRUCTURE TO THE WRITE ROUTINE</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DIMITRI_INTERFACE_EXTRACT_TOA_NCDF: SENDING DATA TO OUTPUT ROUTINE'
  WRITE_DIMITRI_EXTRACT_TOA_NCDF,TEMP_STRUCT,NCDF_FILENAME,VERBOSE=VERBOSE

<span class="comments">;-----------------------------------</span>
<span class="comments">; CHECK NEW FILE HAS BE GENERATED OK</span>

  IF FILE_TEST(NCDF_FILENAME) THEN ERROR = 0 ELSE ERROR = 1

<span class="comments">;-----------------------------------</span>
<span class="comments">; DELETE THE TEMP BACKUP</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'DIMITRI_INTERFACE_EXTRACT_TOA_NCDF: REMOVING TEMP BACKUP (IF NOMINAL) AND RETURNING'
  IF ERROR EQ 0 AND NCDF_DATA.ERROR EQ 0 THEN FILE_DELETE,NCDF_FILENAME+TB_STR
  RETURN,ERROR

END
</code>
    </div>
  </body>
</html>