<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Thu Jul  4 16:01:31 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>save_dimitri_database.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="save_dimitri_database.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;*</span>
<span class="comments">;* NAME:</span>
<span class="comments">;*      SAVE_DIMITRI_DATABASE       </span>
<span class="comments">;* </span>
<span class="comments">;* PURPOSE:</span>
<span class="comments">;*      SAVES DATA TO THE DIMITRI DATABASE FILE</span>
<span class="comments">;* </span>
<span class="comments">;* CALLING SEQUENCE:</span>
<span class="comments">;*      RES = SAVE_DIMITRI_DATABASE(DB_DATA)      </span>
<span class="comments">;* </span>
<span class="comments">;* INPUTS:</span>
<span class="comments">;*      DB_DATA = A DATABASE STRUCTURE TAKEN FROM GET_DIMITRI_TEMPLATE</span>
<span class="comments">;*</span>
<span class="comments">;* KEYWORDS:</span>
<span class="comments">;*      VERBOSE  - PROCESSING STATUS OUTPUTS</span>
<span class="comments">;*</span>
<span class="comments">;* OUTPUTS:</span>
<span class="comments">;*      STATUS   - 1: NOMINAL, (-1) OR 0: ERROR</span>
<span class="comments">;*</span>
<span class="comments">;* COMMON BLOCKS:</span>
<span class="comments">;*      NONE</span>
<span class="comments">;*</span>
<span class="comments">;* MODIFICATION HISTORY:</span>
<span class="comments">;*      14 MAR 2011 - C KENT   - DIMITRI-2 V1.0</span>
<span class="comments">;*      21 MAR 2011 - C KENT   - MODIFIED FILE DEFINITION TO USE GET_DIMITRI_LOCATION</span>
<span class="comments">;*      06 JUL 2011 - C KENT   - ADDED INFO WIDGET WARNING USERS OF SAVING PROCESS</span>
<span class="comments">;*      30 AUG 2011 - C KENT   - MODIFIED DATABASE SAVING SECTION FOR OPTIMISED PERFORMANCE</span>
<span class="comments">;*      08 MAR 2012 - C KENT   - UPDATED BACKUP FILENAME, ADDED ROI_COVER</span>
<span class="comments">;*</span>
<span class="comments">;* VALIDATION HISTORY:</span>
<span class="comments">;*      12 APR 2011 - C KENT   - LINUX 64-BIT IDL 8.0 & WINDOWS 32-BIT IDL 7.1: NOMINAL </span>
<span class="comments">;*                               COMPILATION AND OPERATION</span>
<span class="comments">;*</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

FUNCTION SAVE_DIMITRI_DATABASE,DB_DATA,VERBOSE=VERBOSE

<span class="comments">;----------------------------------------</span>
<span class="comments">; INFORM THE USER THAT IT MAY TAKE AWHILE</span>

  DIMS  = GET_SCREEN_SIZE()
  XSIZE = 200
  YSIZE = 60
  XLOC  = (DIMS[0]/2)-(XSIZE/2)
  YLOC  = (DIMS[1]/2)-(YSIZE/2)

  INFO_WD = WIDGET_BASE(COLUMN=1, XSIZE=XSIZE, YSIZE=YSIZE, TITLE='Please Wait...',XOFFSET=XLOC,YOFFSET=YLOC)
  LBLTXT  = WIDGET_LABEL(INFO_WD,VALUE=' ')
  LBLTXT  = WIDGET_LABEL(INFO_WD,VALUE='Please wait,')
  LBLTXT  = WIDGET_LABEL(INFO_WD,VALUE='Saving Database data...')
  WIDGET_CONTROL, INFO_WD, /REALIZE
  WIDGET_CONTROL, /HOURGLASS

<span class="comments">;----------------------------------------</span>
<span class="comments">; GET DATABASE PARAMETERS</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'DIMITRI DATABASE SAVE: RETRIEVING FORMAT,HEADER AND TEMPLATE'
  DB_ITER   = N_ELEMENTS(DB_DATA.(0))
  DB_FORMAT = GET_DIMITRI_TEMPLATE(1,/FORMAT,VERBOSE=VERBOSE)
  DB_HEADER = GET_DIMITRI_TEMPLATE(1,/HDR,VERBOSE=VERBOSE)
  DB_TEMPLATE = GET_DIMITRI_TEMPLATE(1,/TEMPLATE,VERBOSE=VERBOSE)

<span class="comments">;----------------------</span>
<span class="comments">; IDENTIFIY CURRENT DIRECTORY </span>
<span class="comments">; AND DATABASE FOLDER</span>

  DL          = GET_DIMITRI_LOCATION('DL')
  DB_BACKUP   = GET_DIMITRI_LOCATION('DB_BACKUP')
  DIMITRI_DB  = GET_DIMITRI_LOCATION('DATABASE')
  RES         = SYSTIME(/UTC)
  DY          = FIX(STRMID(RES,8,2)) LT 10 ? '0'+STRMID(RES,8,2) : STRMID(RES,8,2)
  BKUP_DB     = DB_BACKUP+DL+DY+'_'+STRUPCASE(STRMID(RES,4,3))+'_'+STRMID(RES,20,4)+'_DIMITRI_DATABASE.CSV'

<span class="comments">;----------------------</span>
<span class="comments">; CREATE BACKUP FOLDER IF </span>
<span class="comments">; IT DOESN'T EXIST</span>
  
  RES = FILE_INFO(DB_BACKUP)
  IF RES.DIRECTORY EQ 0 THEN BEGIN
    IF KEYWORD_SET(VERBOSE) THEN PRINT,'DIMITRI DATABASE SAVE: CREATING BACKUP FOLDER'
    FILE_MKDIR,DB_BACKUP
  ENDIF

<span class="comments">;----------------------</span>
<span class="comments">; SAVE THE ORIGINAL DATABASE INTO </span>
<span class="comments">; BACKUP FOLDER, DELETE IT </span>
<span class="comments">; AND CREATE A NEW VERSION</span>
    
  FILE_COPY,DIMITRI_DB,BKUP_DB,/OVERWRITE
  FILE_DELETE,DIMITRI_DB
  OPENW,DB_LUN,DIMITRI_DB,/GET_LUN
  PRINTF,DB_LUN,DB_HEADER

<span class="comments">;---------------------------------------</span>
<span class="comments">; OPEN THE DATABASE AND APPEND DATA</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'DIMITRI DATABASE SAVE: PRINTING DATA'  
<span class="comments">;  DBI = TRANSPOSE([                                                                                                 $</span>
<span class="comments">;                    [STRING(DB_DATA.(0))],  [STRING(DB_DATA.(1))],  [STRING(DB_DATA.(2))],  [STRING(DB_DATA.(3))]   ,$</span>
<span class="comments">;                    [STRING(DB_DATA.(4))],  [STRING(DB_DATA.(5))],  [STRING(DB_DATA.(6))],  [STRING(DB_DATA.(7))]   ,$</span>
<span class="comments">;                    [STRING(DB_DATA.(8))],  [STRING(DB_DATA.(9))],  [STRING(DB_DATA.(10))], [STRING(DB_DATA.(11))]  ,$</span>
<span class="comments">;                    [STRING(DB_DATA.(12))], [STRING(DB_DATA.(13))], [STRING(DB_DATA.(14))], [STRING(DB_DATA.(15))]  ,$</span>
<span class="comments">;                    [STRING(DB_DATA.(16))], [STRING(DB_DATA.(17))], [STRING(DB_DATA.(18))], [STRING(DB_DATA.(19))]  ,$</span>
<span class="comments">;                    [STRING(DB_DATA.(20))], [STRING(DB_DATA.(21))], [STRING(DB_DATA.(22))], [STRING(DB_DATA.(23))]   $                      </span>
<span class="comments">;                  ]) </span>
<span class="comments">;  PRINTF,DB_LUN,DBI,FORMAT='(23(A,1H;),A)'</span>
  FOR DBI = 0L,DB_ITER-1 DO BEGIN
    PRINTF,DB_LUN,FORMAT=DB_FORMAT,$
      DB_DATA.DIMITRI_DATE[DBI],$
      DB_DATA.REGION[DBI],$
      DB_DATA.SENSOR[DBI],$
      DB_DATA.PROCESSING_VERSION[DBI],$
      DB_DATA.YEAR[DBI],$
      DB_DATA.MONTH[DBI],$
      DB_DATA.DAY[DBI],$
      DB_DATA.DOY[DBI],$
      DB_DATA.DECIMAL_YEAR[DBI],$
      DB_DATA.FILENAME[DBI],$
      DB_DATA.ROI_COVER[DBI],$
      DB_DATA.NUM_ROI_PX[DBI],$
      DB_DATA.AUTO_CS[DBI],$
      DB_DATA.MANUAL_CS[DBI],$
      DB_DATA.AUX_DATA_1[DBI],$
      DB_DATA.AUX_DATA_2[DBI],$
      DB_DATA.AUX_DATA_3[DBI],$
      DB_DATA.AUX_DATA_4[DBI],$
      DB_DATA.AUX_DATA_5[DBI],$
      DB_DATA.AUX_DATA_6[DBI],$
      DB_DATA.AUX_DATA_7[DBI],$
      DB_DATA.AUX_DATA_8[DBI],$
      DB_DATA.AUX_DATA_9[DBI],$
      DB_DATA.AUX_DATA_10[DBI]
  ENDFOR

<span class="comments">;----------------------</span>
<span class="comments">; CLOSE THE DATABASE FILE AND RETURN NOMINAL STATUS</span>

  FREE_LUN,DB_LUN
  WIDGET_CONTROL,INFO_WD,/DESTROY
  RETURN,1

END
</code>
    </div>
  </body>
</html>