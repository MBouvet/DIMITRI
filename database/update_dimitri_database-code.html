<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Tue Jul  2 12:50:44 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>update_dimitri_database.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="update_dimitri_database.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;*</span>
<span class="comments">;* NAME:</span>
<span class="comments">;*      UPDATE_DIMITRI_DATABASE       </span>
<span class="comments">;* </span>
<span class="comments">;* PURPOSE:</span>
<span class="comments">;*      APPENDS DATA TO THE DIMITRI DATABASE FILE</span>
<span class="comments">;* </span>
<span class="comments">;* CALLING SEQUENCE:</span>
<span class="comments">;*      RES = UPDATE_DIMITRI_DATABASE(DB_DATA)      </span>
<span class="comments">;* </span>
<span class="comments">;* INPUTS:</span>
<span class="comments">;*      DB_DATA = A DATABASE STRUCTURE TAKEN FROM GET_DIMITRI_TEMPLATE</span>
<span class="comments">;*</span>
<span class="comments">;* KEYWORDS:</span>
<span class="comments">;*      SORT_DB  - SET TO SORT THE DATABSE ONCE UPDATED</span>
<span class="comments">;*      VERBOSE  - PROCESSING STATUS OUTPUTS</span>
<span class="comments">;*</span>
<span class="comments">;* OUTPUTS:</span>
<span class="comments">;*      STATUS   - 1: NOMINAL, (-1) OR 0: ERROR</span>
<span class="comments">;*</span>
<span class="comments">;* COMMON BLOCKS:</span>
<span class="comments">;*      NONE</span>
<span class="comments">;*</span>
<span class="comments">;* MODIFICATION HISTORY:</span>
<span class="comments">;*      01 DEC 2010 - C KENT   - DIMITRI-2 V1.0</span>
<span class="comments">;*      02 DEC 2010 - C KENT   - UPDATED HEADER INFORMATION AND SLIGHT CODE MODIFICATION </span>
<span class="comments">;*      21 MAR 2011 - C KENT   - MODIFIED FILE DEFINITION TO USE GET_DIMITRI_LOCATION</span>
<span class="comments">;*      09 MAR 2012 - C KENT   - ADDED ROI_COVER</span>
<span class="comments">;*</span>
<span class="comments">;* VALIDATION HISTORY:</span>
<span class="comments">;*      02 DEC 2010 - C KENT   - WINDOWS 32BIT MACHINE IDL 7.1: COMPILATION SUCCESSFUL, </span>
<span class="comments">;*                               TESTED DURING VALIDATION OF INGEST_MERIS_PRODUCT WITH MULTIPLE PRODUCTS</span>
<span class="comments">;*      12 APR 2011 - C KENT   - LINUX 64-BIT IDL 8.0: NOMINAL COMPILATION AND OPERATION</span>
<span class="comments">;*</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

FUNCTION UPDATE_DIMITRI_DATABASE,DB_DATA,SORT_DB=SORT_DB,VERBOSE=VERBOSE

<span class="comments">;----------------------------------------</span>
<span class="comments">;GET DATABASE PARAMETERS</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'DIMITRI DATABASE UPDATE: RETRIEVING NUMBER OF FILES,FORMAT,HEADER AND TEMPLATE'
  DB_ITER   = N_ELEMENTS(DB_DATA.(0))
  DB_FORMAT = GET_DIMITRI_TEMPLATE(1,/FORMAT,VERBOSE=VERBOSE)
  DB_HEADER = GET_DIMITRI_TEMPLATE(1,/HDR,VERBOSE=VERBOSE)
  DB_TEMPLATE = GET_DIMITRI_TEMPLATE(1,/TEMPLATE,VERBOSE=VERBOSE)
  
<span class="comments">;----------------------------------------</span>
<span class="comments">; CHECK THAT THE DATABASE FILE EXISTS - IF NOT REGENERATE</span>
  
  DIMITRI_DB = GET_DIMITRI_LOCATION('DATABASE')
  TEMP = FILE_INFO(DIMITRI_DB)

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'DIMITRI DATABASE UPDATE: CHECKING EXISTENCE OF DATABASE FILE'  
  IF TEMP.EXISTS EQ 0 THEN BEGIN
  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'DIMITRI DATABASE UPDATE: DATABASE FILE NOT FOUND, REGENERATING NEW VERSION' 
    OPENW,DB_LUN,DIMITRI_DB,/GET_LUN
    PRINTF,DB_LUN,DB_HEADER
    FREE_LUN,DB_LUN
  ENDIF

<span class="comments">;---------------------------------------</span>
<span class="comments">; OPEN THE DATABASE AND APPEND DATA</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'DIMITRI DATABASE UPDATE: OPENING DATABASE AND APPENDING DATA'  
  OPENW,DB_LUN,DIMITRI_DB,/GET_LUN,/APPEND
  FOR DBI = 0L,DB_ITER-1 DO BEGIN
    PRINTF,DB_LUN,FORMAT=DB_FORMAT,$
      DB_DATA.DIMITRI_DATE[DBI],$
      DB_DATA.REGION[DBI],$
      DB_DATA.SENSOR[DBI],$
      DB_DATA.PROCESSING_VERSION[DBI],$
      DB_DATA.YEAR[DBI],$
      DB_DATA.MONTH[DBI],$
      DB_DATA.DAY[DBI],$
      DB_DATA.DOY[DBI],$
      DB_DATA.DECIMAL_YEAR[DBI],$
      DB_DATA.FILENAME[DBI],$
      DB_DATA.ROI_COVER[DBI],$
      DB_DATA.NUM_ROI_PX[DBI],$
      DB_DATA.AUTO_CS[DBI],$
      DB_DATA.MANUAL_CS[DBI],$
      DB_DATA.AUX_DATA_1[DBI],$
      DB_DATA.AUX_DATA_2[DBI],$
      DB_DATA.AUX_DATA_3[DBI],$
      DB_DATA.AUX_DATA_4[DBI],$
      DB_DATA.AUX_DATA_5[DBI],$
      DB_DATA.AUX_DATA_6[DBI],$
      DB_DATA.AUX_DATA_7[DBI],$
      DB_DATA.AUX_DATA_8[DBI],$
      DB_DATA.AUX_DATA_9[DBI],$
      DB_DATA.AUX_DATA_10[DBI]
  ENDFOR

<span class="comments">;------------------------------------------</span>
<span class="comments">; CLOSE THE DATABASE AND FREE MEMORY</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'DIMITRI DATABASE UPDATE: CLOSING DATABASE FILE'     
  FREE_LUN,DB_LUN
  DB_DATA = 0 

<span class="comments">;------------------------------------------</span>
<span class="comments">; IF REQUESTED, SORT THE ENTIRE DATABASE</span>

  IF KEYWORD_SET(SORT_DB) THEN BEGIN
    IF KEYWORD_SET(VERBOSE) THEN PRINT, 'DIMITRI DATABASE UPDATE: SORTING DATABASE FILE INTO ORDER'  
<span class="comments">;------------------------------------------</span>
<span class="comments">; READ THE DATABASE AND COMPUTE A STRING A REQUIRED DATA</span>

    DB_DATA = READ_ASCII(DIMITRI_DB,TEMPLATE=DB_TEMPLATE)
    DB_ITER = N_ELEMENTS(DB_DATA.(0))
    TEMP    = STRARR(DB_ITER)

    FOR DBI = 0L,DB_ITER-1 DO BEGIN
      TEMP_YEAR =  STRTRIM(STRING(DB_DATA.YEAR[DBI]),2)<span class="comments">;STRING(DB_DATA.YEAR[DBI],FORMAT='I4.4')</span>
      TEMP_MONTH = DB_DATA.MONTH[DBI] LE 9 ? '0'+STRTRIM(STRING(DB_DATA.MONTH[DBI]),2) : STRTRIM(STRING(DB_DATA.MONTH[DBI]),2)
      TEMP_DAY =   DB_DATA.DAY[DBI]   LE 9 ? '0'+STRTRIM(STRING(DB_DATA.DAY[DBI]),2) : STRTRIM(STRING(DB_DATA.DAY[DBI]),2)
      TEMP[DBI] = STRING(DB_DATA.REGION[DBI]+DB_DATA.SENSOR[DBI]+DB_DATA.PROCESSING_VERSION[DBI]+TEMP_YEAR+TEMP_MONTH+TEMP_DAY) 
    ENDFOR

<span class="comments">;------------------------------------------</span>
<span class="comments">; SORT THE DATA BASED ON THE GENERATED STRINGS</span>

    DB_INDX = SORT(TEMP)

<span class="comments">;------------------------------------------</span>
<span class="comments">; OPEN A TEMPORARY DATABASE FILE AND PRINT SORTED DATA</span>

    IF KEYWORD_SET(VERBOSE) THEN PRINT, 'DIMITRI DATABASE UPDATE: OPENING A TEMPORARY DATABASE FILE'  
    TEMP_DB = DIMITRI_DB+'.TEMP'
    OPENW,DB_LUN,TEMP_DB,/GET_LUN
    PRINTF,DB_LUN,DB_HEADER   
    IF KEYWORD_SET(VERBOSE) THEN PRINT, 'DIMITRI DATABASE UPDATE: UPDATING TEMPORARY DATABASE FILE'  
    FOR DBI = 0L,DB_ITER-1 DO BEGIN
      PRINTF,DB_LUN,FORMAT=DB_FORMAT,$
        DB_DATA.DIMITRI_DATE[DB_INDX[DBI]],$
        DB_DATA.REGION[DB_INDX[DBI]],$
        DB_DATA.SENSOR[DB_INDX[DBI]],$
        DB_DATA.PROCESSING_VERSION[DB_INDX[DBI]],$
        DB_DATA.YEAR[DB_INDX[DBI]],$
        DB_DATA.MONTH[DB_INDX[DBI]],$
        DB_DATA.DAY[DB_INDX[DBI]],$
        DB_DATA.DOY[DB_INDX[DBI]],$
        DB_DATA.DECIMAL_YEAR[DB_INDX[DBI]],$
        DB_DATA.FILENAME[DB_INDX[DBI]],$
        DB_DATA.ROI_COVER[DB_INDX[DBI]],$
        DB_DATA.NUM_ROI_PX[DB_INDX[DBI]],$
        DB_DATA.AUTO_CS[DB_INDX[DBI]],$
        DB_DATA.MANUAL_CS[DB_INDX[DBI]],$
        DB_DATA.AUX_DATA_1[DB_INDX[DBI]],$
        DB_DATA.AUX_DATA_2[DB_INDX[DBI]],$
        DB_DATA.AUX_DATA_3[DB_INDX[DBI]],$
        DB_DATA.AUX_DATA_4[DB_INDX[DBI]],$
        DB_DATA.AUX_DATA_5[DB_INDX[DBI]],$
        DB_DATA.AUX_DATA_6[DB_INDX[DBI]],$
        DB_DATA.AUX_DATA_7[DB_INDX[DBI]],$
        DB_DATA.AUX_DATA_8[DB_INDX[DBI]],$
        DB_DATA.AUX_DATA_9[DB_INDX[DBI]],$
        DB_DATA.AUX_DATA_10[DB_INDX[DBI]]
    ENDFOR    
    
<span class="comments">;----------------------------------------</span>
<span class="comments">; CLOSE THE TEMPORARY DATABASE, CHECK THAT IT EXISTS, </span>
<span class="comments">; DELETE THE OLD DATABASE AND REPLACE WITH THE SORTED VERSION    </span>
 
    IF KEYWORD_SET(VERBOSE) THEN PRINT, 'DIMITRI DATABASE UPDATE: FREEING LUN, IF TEMPORARY FILE SUCCESSFULLY GENERATED THEN REPLACE OLD FILE'     
    FREE_LUN,DB_LUN
    TEMP = FILE_INFO(DIMITRI_DB+'.TEMP')
    IF TEMP.EXISTS EQ 1 THEN BEGIN
      FILE_DELETE,DIMITRI_DB
      FILE_COPY,DIMITRI_DB+'.TEMP',DIMITRI_DB
      FILE_DELETE,DIMITRI_DB+'.TEMP'
    ENDIF ELSE PRINT, 'DIMITRI DATABASE UPDATE: ERROR, TEMPORARY DATABASE DOES NOT EXIST, DATABASE NOT SORTED'


  ENDIF <span class="comments">;END OF SORT_DB KEYWORD</span>

  RETURN,1
END
</code>
    </div>
  </body>
</html>